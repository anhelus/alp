
<!doctype html>
<html lang="it" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.6">
    
    
      
        <title>03 tdd - Informatica per l'Ingegneria (classe N)</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.35e1ed30.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-J2XESD8WDV"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-J2XESD8WDV",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-J2XESD8WDV",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#obiettivi" class="md-skip">
          Vai al contenuto
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Intestazione">
    <a href="../../.." title="Informatica per l&#39;Ingegneria (classe N)" class="md-header__button md-logo" aria-label="Informatica per l'Ingegneria (classe N)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Informatica per l'Ingegneria (classe N)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              03 tdd
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Cerca" placeholder="Cerca" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Cerca">
        
        <button type="reset" class="md-search__icon md-icon" title="Cancella" aria-label="Cancella" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inizializza la ricerca
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigazione" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Informatica per l&#39;Ingegneria (classe N)" class="md-nav__button md-logo" aria-label="Informatica per l'Ingegneria (classe N)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Informatica per l'Ingegneria (classe N)
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home del corso
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Indice">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Indice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#obiettivi" class="md-nav__link">
    Obiettivi
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#come-testare-il-nostro-software" class="md-nav__link">
    Come testare il nostro software?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-base" class="md-nav__link">
    Setup base
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unapplicazione-reale" class="md-nav__link">
    Un'applicazione reale
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creazione-di-un-nuovo-articolo" class="md-nav__link">
    Creazione di un nuovo articolo
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-delle-fixture" class="md-nav__link">
    Test delle fixture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lista-di-tutti-gli-articoli" class="md-nav__link">
    lista di tutti gli articoli
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#get-article-by-id" class="md-nav__link">
    Get Article by ID
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#esporre-lapi-con-flask" class="md-nav__link">
    Esporre l'API con Flask
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-coverage" class="md-nav__link">
    Code Coverage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-end-to-end" class="md-nav__link">
    Test end-to-end
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-pyramid" class="md-nav__link">
    Testing Pyramid
  </a>
  
    <nav class="md-nav" aria-label="Testing Pyramid">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test-pyramid" class="md-nav__link">
    Test Pyramid
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cosa-e-una-unit" class="md-nav__link">
    Cosa è una Unit?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#perche-testare" class="md-nav__link">
    Perché testare?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cosa-testare" class="md-nav__link">
    Cosa testare?
  </a>
  
    <nav class="md-nav" aria-label="Cosa testare?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#per-cui-cosa-e-ununit" class="md-nav__link">
    Per cui cosa è un'unit?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quando-usare-i-mocks" class="md-nav__link">
    Quando usare i mocks?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pensieri-finali" class="md-nav__link">
    Pensieri finali
  </a>
  
    <nav class="md-nav" aria-label="Pensieri finali">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#conclusione" class="md-nav__link">
    Conclusione
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>03 tdd</h1>

<p>Il test di codice production-grade è duro. Alle volte può prendere tutto il tempo necessario allo sviluppo delle feature. Inoltre, anche se abbiamo una copertura del 100% e tutti i test riesono, potremmo essere sempre non confidenti rispetto al fatto che la nuova feature funzionerà bene in produzione.</p>
<p>In questo articoo vedremocome sviluppare un'app usando il Test-Driven Development (TDD). Vedremo come e cosa testare. Useremo pytest per il testing, pydantic per validare i dati e ridurre il numero di test richiesti, e Flask per fornire un'interfaccia ai client con una API RESTful. Alla fine, avremo un pattern solido che possiamo usare per progetti Python generici, in modo da avere una certa confidenza sul fatto che i test passati indicano un software funzionante.</p>
<h2 id="obiettivi">Obiettivi<a class="headerlink" href="#obiettivi" title="Permanent link">&para;</a></h2>
<p>In questo articolo, vedremo come:</p>
<ul>
<li>Spiegare come dovremo eseguire i test sul nostro software</li>
<li>Configurare pytest ed impostare una struttura di progetto per i test </li>
<li>Definire dei modelli database con pydantic</li>
<li>USare le fixture di pytest per gestire lo stato del test e valutare dei side effect</li>
<li>Verificare le risposte JSON rispetto alle definizioni sullo Schema JSON</li>
<li>Organizzare le operazioni sul database mediante comandi (che cambiano lo stao ed hanno effetti collaterali) e query (read-only, senza effetti collateriali)</li>
<li>Scrivere unit test, integration test ed end-to-end test mediante pytest</li>
<li>Spiegare perché sia importante foalizzare gli sforzi di test sul comportamento del test piuttosto che sui dettagli implementativi</li>
</ul>
<h2 id="come-testare-il-nostro-software">Come testare il nostro software?<a class="headerlink" href="#come-testare-il-nostro-software" title="Permanent link">&para;</a></h2>
<p>Gli sviluppatori software tendono ad essere molto soggettivi sul testing. A causa di questo, hanno opinioni divergenti su quanto è importante il test, ed idee divergenti su come farlo. Detto questo, vediamo tre linee guida su cui sperabilmente la maggior parte degli sviluppatori concorderà e che ci aiutano a scrivere test ottimali:</p>
<ul>
<li>i test devono indicare il comportamento atteso dell'unità sotto test. Quindi, è preferibile mantenerli brevi e dritti al punto. La struttura GIVEN, WHEN, THEN può aiutarci a farlo:</li>
</ul>
<p>GIVEN - quali sono le condizioni iniziali per il test?<br />
WHEN - cosa deve essere testato?<br />
THEN - quale è la risposta attesa?</p>
<p>Per cui dovremmo preparare il nostro ambiente per il testing, eseguire il comportamento e, alla fine, controllare che gli output rispettino le attese.</p>
<p>Ogni parte di comportamento deve essere testata una ed una sola volta. Testare lo stesso comportamento non significa che il nostro software funzionerà meglio. I test devono essere anche manutenuti. Se facciamo un piccolo cambio alla nostra code base e si rompono venti test, come sappiamo quale funzionalità è rotta? Quando invece è soltanto un singolo test a rompersi, è molto più semplice individuare il bug.</p>
<p>Ogni test deve essere indipendente dagli altri. Altrimenti, avremo difficoltà a mentenere ed eseguire la suite di test.</p>
<p>Questo articolo è soggettivo anche. Non prendiamo tutto come il sacro graal o un proiettile d'argento.</p>
<h2 id="setup-base">Setup base<a class="headerlink" href="#setup-base" title="Permanent link">&para;</a></h2>
<p>Detto questo, è giunto il momento di sporcarci le mani. Vediamo, in pratica, cosa significa questo nel mondo reale. Il test più semplice che possiamo eseguire mediante pytest è il seguente:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">another_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="k">def</span> <span class="nf">test_another_sum</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">another_sum</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
</code></pre></div>
<p>Questo è l'esempio che probabilmente tutti noi abbiamo visto almeno una volta. Per prima cosa, non scriveremo mai dei test all'interno della nostra codebase, per cui suddividiamo questo in due file e package.</p>
<p>Creiamo una nuova cartella per questo progetto e spostiamoci al suo interno:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mkdir<span class="w"> </span>testing_project
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>testing_project
</code></pre></div>
<p>A questo punto, creiamo ed attiviamo un ambiente virtuale.</p>
<p>Installiamo quindi pytest:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest
</code></pre></div>
<p>Dopo aver fatto questo, creiamo una nuova cartella chiamata <code>sum</code>. Aggiungiamo un file <code>__init__.py</code> nella cartella per trasformarla in un package, assieme ad un file <code>another_sum.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">another_sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</code></pre></div>
<p>Aggiungiamo un'altra cartella <strong>tests</strong> ed aggiungiamo i seguenti file e cartelle:</p>
<div class="highlight"><pre><span></span><code>└── tests
    ├── __init__.py
    └── test_sum
        ├── __init__.py
        └── test_another_sum.py
</code></pre></div>
<p>Dovremmo avere quindi una struttura di questo tipo:</p>
<div class="highlight"><pre><span></span><code>├── sum
│   ├── __init__.py
│   └── another_sum.py
└── tests
    ├── __init__.py
    └── test_sum
        ├── __init__.py
        └── test_another_sum.py
</code></pre></div>
<p>Nel file <code>test_another_sum.py</code> aggiungiamo:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">sum.another_sum</span> <span class="kn">import</span> <span class="n">another_sum</span>


<span class="k">def</span> <span class="nf">test_another_sum</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">another_sum</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
</code></pre></div>
<p>A questo punto, aggiungiamo un file <code>conftest.py</code> vuoto, che viene usato per memorizzare le fixture di pytest, assieme alla cartella <strong>tests</strong>.</p>
<p>Infine, aggiungiamo un file <code>pytest.ini</code> (ovvero, un file di configurazione pytest)</p>
<p>La struttura finale del progetto è come segue:</p>
<div class="highlight"><pre><span></span><code>├── sum
│   ├── __init__.py
│   └── another_sum.py
└── tests
    ├── __init__.py
    ├── conftest.py
    ├── pytest.ini
    └── test_sum
        ├── __init__.py
        └── test_another_sum.py
</code></pre></div>
<p>In definitiva, tenere i test assieme all'interno di un singolo package ci permette di:</p>
<ul>
<li>riutilizzare la configurazione di pytest in tutti i test</li>
<li>riutilizzare le fixture in tutti i test</li>
<li>semplificare l'esecuzione dei test</li>
</ul>
<p>Possiamo eseguire tutti i test con questo comando:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests
</code></pre></div>
<p>Dovremmo quindi vedere i risultati dei test, che in questo caso valgono:</p>
<div class="highlight"><pre><span></span><code><span class="o">==============================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==============================</span>
platform<span class="w"> </span>darwin<span class="w"> </span>--<span class="w"> </span>Python<span class="w"> </span><span class="m">3</span>.10.1,<span class="w"> </span>pytest-7.0.1,<span class="w"> </span>pluggy-1.0.0
rootdir:<span class="w"> </span>/testing_project/tests,<span class="w"> </span>configfile:<span class="w"> </span>pytest.ini
collected<span class="w"> </span><span class="m">1</span><span class="w"> </span>item

tests/test_sum.py/test_another_sum.py<span class="w"> </span>.<span class="w">                                 </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">===============================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.01s<span class="w"> </span><span class="o">===============================</span>
</code></pre></div>
<h2 id="unapplicazione-reale">Un'applicazione reale<a class="headerlink" href="#unapplicazione-reale" title="Permanent link">&para;</a></h2>
<p>Ora che abbiamo l'idea base di come impostare e strutturare i nostri test, costruiamo un semplice blog. Lo costruiremo usando il TDD per vedere il test in azione. Useremo Flask come framework web e, per focalizzarci sul testing, SQLite come database.</p>
<p>La nostra app avrà i seguenti requisiti:</p>
<ul>
<li>potremo creare degli aritcoli</li>
<li>leggere articoli</li>
<li>restituire una lista di articoli</li>
</ul>
<p>Per prima cosa, creiamo un nuovo progetto:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mkdir<span class="w"> </span>blog_app
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>blog_app
</code></pre></div>
<p>A questo punto, creiamo ed attiviamo un nuovo ambiente virtuale. Installiamo al suo interno pytest e pydantic, una liberia per il parsing e la validazione dei dati:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;pydantic[email]&quot;</span>
</code></pre></div>
<p>Notiamo che stiamo installando "pydantic[email]", che ci permette di installare pydantic con un validatore delle email, che useremo per validare gli indirizzi email inseriti.</p>
<p>A questo punto, creiamo i seguenti file e cartelle:</p>
<div class="highlight"><pre><span></span><code>blog_app
    ├── blog
    │   ├── __init__.py
    │   ├── app.py
    │   └── models.py
    └── tests
        ├── __init__.py
        ├── conftest.py
        └── pytest.ini
</code></pre></div>
<p>Aggiungiamo il seguente codice al file <code>models.py</code> per definire il modello per un nuovo Articolo mediante pydantic:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span><span class="p">,</span> <span class="n">Field</span>


<span class="k">class</span> <span class="nc">NotFound</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>
    <span class="n">author</span><span class="p">:</span> <span class="n">EmailStr</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_by_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">article_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DATABASE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;database.db&quot;</span><span class="p">))</span>
        <span class="n">con</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>

        <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM articles WHERE id=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">article_id</span><span class="p">,))</span>

        <span class="n">record</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFound</span>

        <span class="n">article</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">record</span><span class="p">)</span>  <span class="c1"># Row can be unpacked as dict</span>
        <span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">article</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_by_title</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DATABASE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;database.db&quot;</span><span class="p">))</span>
        <span class="n">con</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>

        <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM articles WHERE title = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">title</span><span class="p">,))</span>

        <span class="n">record</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFound</span>

        <span class="n">article</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">record</span><span class="p">)</span>  <span class="c1"># Row can be unpacked as dict</span>
        <span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">article</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;Article&quot;</span><span class="p">]:</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DATABASE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;database.db&quot;</span><span class="p">))</span>
        <span class="n">con</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>

        <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM articles&quot;</span><span class="p">)</span>

        <span class="n">records</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">record</span><span class="p">)</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">]</span>
        <span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">articles</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Article&quot;</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DATABASE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;database.db&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">con</span><span class="p">:</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">&quot;INSERT INTO articles (id,author,title,content) VALUES(?, ?, ?, ?)&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">database_name</span><span class="o">=</span><span class="s2">&quot;database.db&quot;</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">database_name</span><span class="p">)</span>

        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;CREATE TABLE IF NOT EXISTS articles (id TEXT, author TEXT, title TEXT, content TEXT)&quot;</span>
        <span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
<p>Questo è un modello di tipo Active Record, che fornisce metodi per memorizzare, estrarre un singolo articolo, e creare la lista di tutti gli articoli.</p>
<p>Potremmo chiederci perché non abbiamo scritto dei test per coprire il modello. Lo capiremo a breve.</p>
<h2 id="creazione-di-un-nuovo-articolo">Creazione di un nuovo articolo<a class="headerlink" href="#creazione-di-un-nuovo-articolo" title="Permanent link">&para;</a></h2>
<p>Adesso, vediamo la business logic del nostro modello. Scriveremo alcuni comandi di aiuto e delle query per separare la nostra logica dal modello e delle API. Dal momento che stiamo usando pydantic, possiamo facilmente validare i dati sulla base del modello stesso.</p>
<p>Creiamo quindi un package <strong>test_article</strong> nella cartella <strong>test</strong>. Aggiungiamo quindi un file chiamato <strong>test_commands.py</strong>.</p>
<div class="highlight"><pre><span></span><code>blog_app
    ├── blog
    │   ├── __init__.py
    │   ├── app.py
    │   └── models.py
    └── tests
        ├── __init__.py
        ├── conftest.py
        ├── pytest.ini
        └── test_article
            ├── __init__.py
            └── test_commands.py
</code></pre></div>
<p>Aggiungiamo i seguenti test a <strong>test_commands.py</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Article</span>
<span class="kn">from</span> <span class="nn">blog.commands</span> <span class="kn">import</span> <span class="n">CreateArticleCommand</span><span class="p">,</span> <span class="n">AlreadyExists</span>


<span class="k">def</span> <span class="nf">test_create_article</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GIVEN CreateArticleCommand with valid author, title, and content properties</span>
<span class="sd">    WHEN the execute method is called</span>
<span class="sd">    THEN a new Article must exist in the database with the same attributes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">CreateArticleCommand</span><span class="p">(</span>
        <span class="n">author</span><span class="o">=</span><span class="s2">&quot;john@doe.com&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;New Article&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;Super awesome article&quot;</span>
    <span class="p">)</span>

    <span class="n">article</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="n">db_article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">db_article</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">article</span><span class="o">.</span><span class="n">id</span>
    <span class="k">assert</span> <span class="n">db_article</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="n">article</span><span class="o">.</span><span class="n">author</span>
    <span class="k">assert</span> <span class="n">db_article</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="n">article</span><span class="o">.</span><span class="n">title</span>
    <span class="k">assert</span> <span class="n">db_article</span><span class="o">.</span><span class="n">content</span> <span class="o">==</span> <span class="n">article</span><span class="o">.</span><span class="n">content</span>


<span class="k">def</span> <span class="nf">test_create_article_already_exists</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GIVEN CreateArticleCommand with a title of some article in database</span>
<span class="sd">    WHEN the execute method is called</span>
<span class="sd">    THEN the AlreadyExists exception must be raised</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">Article</span><span class="p">(</span>
        <span class="n">author</span><span class="o">=</span><span class="s2">&quot;jane@doe.com&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;New Article&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;Super extra awesome article&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="n">CreateArticleCommand</span><span class="p">(</span>
        <span class="n">author</span><span class="o">=</span><span class="s2">&quot;john@doe.com&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;New Article&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;Super awesome article&quot;</span>
    <span class="p">)</span>

    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">AlreadyExists</span><span class="p">):</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</code></pre></div>
<p>Questi test coprono i seguenti casi d'uso:</p>
<ul>
<li>gli articoli devono essere creati a partire da dati validi</li>
<li>i titoli degli articoli devono essere unici</li>
</ul>
<p>Eseguiamo i test dalla nostra cartella di progetto per vedere come falliscono:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests
</code></pre></div>
<p>Adesso possiamo implementare i nostri comandi. Aggiungiamo un file commands.py alla cartella <strong>blog</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span>

<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Article</span><span class="p">,</span> <span class="n">NotFound</span>


<span class="k">class</span> <span class="nc">AlreadyExists</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">CreateArticleCommand</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">author</span><span class="p">:</span> <span class="n">EmailStr</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Article</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Article</span><span class="o">.</span><span class="n">get_by_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">AlreadyExists</span>
        <span class="k">except</span> <span class="n">NotFound</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="p">(</span>
            <span class="n">author</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span>
        <span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">article</span>
</code></pre></div>
<h2 id="test-delle-fixture">Test delle fixture<a class="headerlink" href="#test-delle-fixture" title="Permanent link">&para;</a></h2>
<p>Possiamo usare le fixture di pytest per pulire il database dopo ogni test e crearne uno nuovo prima di ogni test. Le fixture sono delle funzioni decorate con un decorator di tipo <code>@pytest.fixture</code>. Di solito, sono collocate all'interno di <code>conftest.py</code>, ma possono essere anche aggiunte ai file di test veri e propri. Queste funzioni sono eseguite di default prima di ogni test.</p>
<p>Un'opzione è quella di usare i valori restituiti all'interno dei nostri test. Ad esempio:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">random_name</span><span class="p">():</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;John&quot;</span><span class="p">,</span> <span class="s2">&quot;Jane&quot;</span><span class="p">,</span> <span class="s2">&quot;Marry&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_fixture_usage</span><span class="p">(</span><span class="n">random_name</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">random_name</span>
<span class="n">So</span><span class="p">,</span> <span class="n">to</span> <span class="n">use</span> <span class="n">the</span> <span class="n">value</span> <span class="n">returned</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">fixture</span> <span class="n">inside</span> <span class="n">the</span> <span class="n">test</span> <span class="n">you</span> <span class="n">just</span> <span class="n">need</span> <span class="n">to</span> <span class="n">add</span> <span class="n">the</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">fixture</span> <span class="n">function</span> <span class="k">as</span> <span class="n">a</span> <span class="n">parameter</span> <span class="n">to</span> <span class="n">the</span> <span class="n">test</span> <span class="n">function</span><span class="o">.</span>

<span class="n">Another</span> <span class="n">option</span> <span class="ow">is</span> <span class="n">to</span> <span class="n">perform</span> <span class="n">a</span> <span class="n">side</span> <span class="n">effect</span><span class="p">,</span> <span class="n">like</span> <span class="n">creating</span> <span class="n">a</span> <span class="n">database</span> <span class="ow">or</span> <span class="n">mocking</span> <span class="n">a</span> <span class="n">module</span><span class="o">.</span>

<span class="n">You</span> <span class="n">can</span> <span class="n">also</span> <span class="n">run</span> <span class="n">part</span> <span class="n">of</span> <span class="n">a</span> <span class="n">fixture</span> <span class="n">before</span> <span class="ow">and</span> <span class="n">part</span> <span class="n">after</span> <span class="n">a</span> <span class="n">test</span> <span class="n">using</span> <span class="k">yield</span> <span class="n">instead</span> <span class="n">of</span> <span class="k">return</span><span class="o">.</span> <span class="n">For</span> <span class="n">example</span><span class="p">:</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">some_fixture</span><span class="p">():</span>
    <span class="c1"># do something before your test</span>
    <span class="k">yield</span> <span class="c1"># test runs here</span>
    <span class="c1"># do something after your test</span>
</code></pre></div>
<p>Adesso, aggiungiamo la seguente fixture a <code>conftest.py</code>, che crea un nuovo database prima di ogni test e lo rimuove immediatamente dopo:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Article</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">database</span><span class="p">():</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DATABASE_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_name</span>
    <span class="n">Article</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span><span class="n">database_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
</code></pre></div>
<p>Il flag <code>autouse</code> è impostato a <code>True</code> in modo che sia automaticamente usato di default prima (e dopo) ogni test nella suite di test. Dal momento che stiamo usando un database per tutti i test ha senso usare questo flag. In questo modo non dobbiamo aggiungere in maniera esplicita il nome della fixture ad ognit est come parametro.</p>
<p>Se non dobbiamo avere accesso al database per un test possiamo disabilitare autouse con un test marker. Possiamo vedere un esempio di questo qui.,</p>
<p>Eseguiamo nuovamente i test:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests
</code></pre></div>
<p>Stavolta, dovrebbero passare.</p>
<p>Come possiamo vedere, i nostri test testano soltanto il comando CreateArticleCommand. Non testiamo il modello Article vero e proprio, in quatno non risulta essere responsabile per la logica di business. Sappiamo che il comando funziona come atteso. Quindi, non c'è la necessità di scrivere ulteriori test.</p>
<h2 id="lista-di-tutti-gli-articoli">lista di tutti gli articoli<a class="headerlink" href="#lista-di-tutti-gli-articoli" title="Permanent link">&para;</a></h2>
<p>Il requisito succesivo è quello di elencare la lista di tutti gli articoli. Useremo una query invece di un comando, per cui aggiungiamo un nuovo file chiamato test<em>queries.py alla cartella test</em>article:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Article</span>
<span class="kn">from</span> <span class="nn">blog.queries</span> <span class="kn">import</span> <span class="n">ListArticlesQuery</span>


<span class="k">def</span> <span class="nf">test_list_articles</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GIVEN 2 articles stored in the database</span>
<span class="sd">    WHEN the execute method is called</span>
<span class="sd">    THEN it should return 2 articles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Article</span><span class="p">(</span>
        <span class="n">author</span><span class="o">=</span><span class="s2">&quot;jane@doe.com&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;New Article&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;Super extra awesome article&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">Article</span><span class="p">(</span>
        <span class="n">author</span><span class="o">=</span><span class="s2">&quot;jane@doe.com&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Another Article&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;Super awesome article&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">query</span> <span class="o">=</span> <span class="n">ListArticlesQuery</span><span class="p">()</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">execute</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span>
</code></pre></div>
<p>Eseguiamo i test:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests
</code></pre></div>
<p>I test dovrebbero adesso fallire.</p>
<p>Aggiungiamo un file <code>queries.py</code> alla cartella <em>blog</em>:</p>
<div class="highlight"><pre><span></span><code>blog_app
    ├── blog
    │   ├── __init__.py
    │   ├── app.py
    │   ├── commands.py
    │   ├── models.py
    │   └── queries.py
    └── tests
        ├── __init__.py
        ├── conftest.py
        ├── pytest.ini
        └── test_article
            ├── __init__.py
            ├── test_commands.py
            └── test_queries.py
</code></pre></div>
<p>Adesso possiamo implementare la nostra query:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Article</span>


<span class="k">class</span> <span class="nc">ListArticlesQuery</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Article</span><span class="p">]:</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">articles</span>
</code></pre></div>
<p>Anche se non abbiamo dei parametri, per consistenza, abbiamo ereditato da <code>BaseModel</code>.</p>
<p>Eseguiamo nuovamente i test:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests
</code></pre></div>
<p>Adesso dovrebbero passare.</p>
<h2 id="get-article-by-id">Get Article by ID<a class="headerlink" href="#get-article-by-id" title="Permanent link">&para;</a></h2>
<p>Ottenere un articolo dal suo ID può essere fatto in modo simile all'elenco di tutti gli aritcopli. Aggiungiamo un nuovo test per GetArticleByIDQuery a test_queries.py:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Article</span>
<span class="kn">from</span> <span class="nn">blog.queries</span> <span class="kn">import</span> <span class="n">ListArticlesQuery</span><span class="p">,</span> <span class="n">GetArticleByIDQuery</span>


<span class="k">def</span> <span class="nf">test_list_articles</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GIVEN 2 articles stored in the database</span>
<span class="sd">    WHEN the execute method is called</span>
<span class="sd">    THEN it should return 2 articles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Article</span><span class="p">(</span>
        <span class="n">author</span><span class="o">=</span><span class="s2">&quot;jane@doe.com&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;New Article&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;Super extra awesome article&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">Article</span><span class="p">(</span>
        <span class="n">author</span><span class="o">=</span><span class="s2">&quot;jane@doe.com&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Another Article&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;Super awesome article&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">query</span> <span class="o">=</span> <span class="n">ListArticlesQuery</span><span class="p">()</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">execute</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span>


<span class="k">def</span> <span class="nf">test_get_article_by_id</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GIVEN ID of article stored in the database</span>
<span class="sd">    WHEN the execute method is called on GetArticleByIDQuery with an ID</span>
<span class="sd">    THEN it should return the article with the same ID</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="p">(</span>
        <span class="n">author</span><span class="o">=</span><span class="s2">&quot;jane@doe.com&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;New Article&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;Super extra awesome article&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">query</span> <span class="o">=</span> <span class="n">GetArticleByIDQuery</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">article</span><span class="o">.</span><span class="n">id</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">query</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">article</span><span class="o">.</span><span class="n">id</span>
</code></pre></div>
<p>Eseguiamo i test per assicurarci che falliscano:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests
</code></pre></div>
<p>Adesso, aggiungiamo GetArticleByIDQuery a queries.py:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Article</span>


<span class="k">class</span> <span class="nc">ListArticlesQuery</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Article</span><span class="p">]:</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">articles</span>


<span class="k">class</span> <span class="nc">GetArticleByIDQuery</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Article</span><span class="p">:</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">article</span>
</code></pre></div>
<p>I test dovrebbero adesso passare:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests
</code></pre></div>
<p>Bene. Abbiamo rispettato tutti i requisiti su menzionati:</p>
<ul>
<li>gli articoli possono essere creati</li>
<li>gli articoli possono essere estratti</li>
<li>gli articoli possono essere elencati</li>
</ul>
<p>E tutto viene coperto da test. Dal momento che stiamo usando pydantic per la validazione dei dati a runtime, non abbiamo bisogno di molti test per coprire la logica di business in quanto non dobbiamo scrivere dei test per validare i dati. Se author non è una email valida, pydantic lancerà un errore. Tutto quello che era necessario era impostare l'attributo author al tipo EmailStr. Non dobbiamo testarlo perché è già stato testato dai mantainer di pydantic.</p>
<p>Con questo, siamo pronti ad esporre questa funzionalità al mondo mediante una API RESTful Flask.</p>
<h2 id="esporre-lapi-con-flask">Esporre l'API con Flask<a class="headerlink" href="#esporre-lapi-con-flask" title="Permanent link">&para;</a></h2>
<p>Introdurremo tre endpoint che coprono questo requisito.</p>
<ul>
<li>/create-article/ - creiamo un nuovo articolo</li>
<li>/article-list/ - recuperiamo tutti gli articoli</li>
<li>/article/<article_id>/ - estraiamo un singolo articolo</li>
</ul>
<p>Per prima cosa, creiamo una cartella chiamata <em>schemas</em> in <em>test_article</em>, ed aggiungiamo due schemi JSON alla stessa, Article.json ed ArticleList.json.</p>
<p>```json "Article.json"<br />
{<br />
  "$schema": "<a href="http://json-schema.org/draft-07/schema#">http://json-schema.org/draft-07/schema#</a>",<br />
  "title": "Article",<br />
  "type": "object",<br />
  "properties": {<br />
    "id": {<br />
      "type": "string"<br />
    },<br />
    "author": {<br />
      "type": "string"<br />
    },<br />
    "title": {<br />
      "type": "string"<br />
    },<br />
    "content": {<br />
      "type": "string"<br />
    }<br />
  },<br />
  "required": ["id", "author", "title", "content"]<br />
}<br />
<div class="highlight"><pre><span></span><code>```json &quot;ArticleList.json&quot;
{
  &quot;$schema&quot;: &quot;http://json-schema.org/draft-07/schema#&quot;,
  &quot;title&quot;: &quot;ArticleList&quot;,
  &quot;type&quot;: &quot;array&quot;,
  &quot;items&quot;: {&quot;$ref&quot;:  &quot;file:Article.json&quot;}
}
</code></pre></div></p>
<p>Gli schemi JSON usati per definire le risposte dagli endpoint API. Prima di continuare, installiamo la libreria jsonschema, che sarà usata per validare i payload JSON, e Flask:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>jsonschema<span class="w"> </span>Flask
</code></pre></div>
<p>A questo punto, scriamo dei test di integrazione per la nostra API. Aggiungiamo un nuovo file chiamato test<em>app.py a test</em>article:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pathlib</span>

<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">jsonschema</span> <span class="kn">import</span> <span class="n">validate</span><span class="p">,</span> <span class="n">RefResolver</span>

<span class="kn">from</span> <span class="nn">blog.app</span> <span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Article</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">client</span><span class="p">():</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;TESTING&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">client</span>


<span class="k">def</span> <span class="nf">validate_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">schema_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate payload with selected schema</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">schemas_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2">/schemas&quot;</span>
    <span class="p">)</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">schemas_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">schema_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
    <span class="n">validate</span><span class="p">(</span>
        <span class="n">payload</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">,</span>
        <span class="n">resolver</span><span class="o">=</span><span class="n">RefResolver</span><span class="p">(</span>
            <span class="s2">&quot;file://&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">schemas_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">schema_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()),</span>
            <span class="n">schema</span>  <span class="c1"># it&#39;s used to resolve the file inside schemas correctly</span>
        <span class="p">)</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">test_create_article</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GIVEN request data for new article</span>
<span class="sd">    WHEN endpoint /create-article/ is called</span>
<span class="sd">    THEN it should return Article in json format that matches the schema</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="s2">&quot;john@doe.com&quot;</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;New Article&quot;</span><span class="p">,</span>
        <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Some extra awesome content&quot;</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;/create-article/&quot;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="n">data</span>
        <span class="p">),</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">validate_payload</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="s2">&quot;Article.json&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_get_article</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GIVEN ID of article stored in the database</span>
<span class="sd">    WHEN endpoint /article/&lt;id-of-article&gt;/ is called</span>
<span class="sd">    THEN it should return Article in json format that matches the schema</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="p">(</span>
        <span class="n">author</span><span class="o">=</span><span class="s2">&quot;jane@doe.com&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;New Article&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;Super extra awesome article&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;/article/</span><span class="si">{</span><span class="n">article</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">,</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">validate_payload</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="s2">&quot;Article.json&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_list_articles</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GIVEN articles stored in the database</span>
<span class="sd">    WHEN endpoint /article-list/ is called</span>
<span class="sd">    THEN it should return list of Article in json format that matches the schema</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Article</span><span class="p">(</span>
        <span class="n">author</span><span class="o">=</span><span class="s2">&quot;jane@doe.com&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;New Article&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;Super extra awesome article&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;/article-list/&quot;</span><span class="p">,</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">validate_payload</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="s2">&quot;ArticleList.json&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Che cosa sta succedendo qui?</p>
<p>Per prima cosa, definiamo il client di test Flask come una fixture, in modo che possa essere usato nei test. A questo punto, aggiungiamo una funzione per la validazione dei payload. In tal senso, usiamo due parametri:</p>
<ul>
<li>payload - la risposta JSON dall'API</li>
<li>schema_name: il nome del file dello schema all'interno della cartella "schemas"</li>
</ul>
<p>Infine, ci sono tre test, uno per ogni endpoint. All'interno di ciascun test vi è una chiamata all'API e la validazione del payload restituito.</p>
<p>Eseguiamo i test per assicurarci che falliscano a questo punto:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests
</code></pre></div>
<p>Adesso possiamo scrivere le API.</p>
<p>Aggiorniamo <code>app.py</code> come segue:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span>

<span class="kn">from</span> <span class="nn">blog.commands</span> <span class="kn">import</span> <span class="n">CreateArticleCommand</span>
<span class="kn">from</span> <span class="nn">blog.queries</span> <span class="kn">import</span> <span class="n">GetArticleByIDQuery</span><span class="p">,</span> <span class="n">ListArticlesQuery</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/create-article/&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_article</span><span class="p">():</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">CreateArticleCommand</span><span class="p">(</span>
        <span class="o">**</span><span class="n">request</span><span class="o">.</span><span class="n">json</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span><span class="o">.</span><span class="n">dict</span><span class="p">())</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/article/&lt;article_id&gt;/&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_article</span><span class="p">(</span><span class="n">article_id</span><span class="p">):</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">GetArticleByIDQuery</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">article_id</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span><span class="o">.</span><span class="n">dict</span><span class="p">())</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/article-list/&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">list_articles</span><span class="p">():</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">ListArticlesQuery</span><span class="p">()</span>
    <span class="n">records</span> <span class="o">=</span> <span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">execute</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<p>I nostri route handler sono abbastanza semplici dato che tutta la logica è coperta da comandi e query. Le azioni disponibili con side effects, come mutazioni, sono rappresentate dai comandi (ad esempio, creare un nuovo articol). D'altro canto, le azioni che non hanno un side effect, quelle che stanno semplicemente leggendo lo stato corrente, sono coperte dalle query.</p>
<p>I pattern delle query ed i comandi usati in questo articolo sono uina versioen semplificata del pattern CQRS. In pratica, stiamo combinando CQRS e CRUD.</p>
<p>Il metodo <code>.dict()</code> di prima viene fornito dal BaseModel di pydantic, da cui tutti i nostri modelli ereditano.</p>
<p>Il test dovrebbe avere successo:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests
</code></pre></div>
<p>Abbiamo coperto gli scenari "corretti". Nel mondo reale ci dovremo aspettare che i client non sempre useranno le API come dovrebbero. Ad esempio, quando la richiesta per creare un articolo è fatta senz aun titolo, sarà lanciato un errore dal comando CreateArticleCommand, che risulterà in un errore interno del server ed uno status HTTP 500. Questo è qualcosa che vogliamo evitare. Quindi, dobbiamo gestire questi errori in modo da notificare l'utente della richiesta sbagliata in maniera "soft".</p>
<p>Scriviamo dei test per coprire questi casi. Aggiungiamo il seguente a <code>test_app.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">&quot;data&quot;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;New Article&quot;</span><span class="p">,</span>
            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Some extra awesome content&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;New Article&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Some extra awesome content&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_create_article_bad_request</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GIVEN request data with invalid values or missing attributes</span>
<span class="sd">    WHEN endpoint /create-article/ is called</span>
<span class="sd">    THEN it should return status 400</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;/create-article/&quot;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="n">data</span>
        <span class="p">),</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</code></pre></div>
<p>Abbiamo usato l'opzione parametrize di pytest, che semplifica il passaggio di più input ad un singolo test.</p>
<p>I test dovrebbero fallire a questo punto perché non abbiamo ancora gestito il <code>ValidationError</code>:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests
</code></pre></div>
<p>Aggiungiamo un error handler all'app Flask all'interno di <code>app.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">ValidationError</span>

<span class="c1"># Other code ...</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">handle_validation_exception</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">errors</span><span class="p">())</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">400</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="c1"># Other code ...</span>
</code></pre></div>
<p>Il <code>ValidationError</code> ha un metodo per la gestione degli errori che restituisce una lista di tutti gli errori per ogni campo che è mancante o passa un valore che non ha passato la validazione. Possiamo semplicemente restituire qeusto nel corpo ed impostare lo status della rsiposta a 400.ù</p>
<p>Ora che l'errore è propriamente gestito, tutti i test dovrebbero passare:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests
</code></pre></div>
<h2 id="code-coverage">Code Coverage<a class="headerlink" href="#code-coverage" title="Permanent link">&para;</a></h2>
<p>Adesso, con l'applicazione testata, è il momento di controlare la copertura del codice. Installiamo un plugin di pytest per far questo chiamato <code>pytest-cov</code>:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pytest-cov
</code></pre></div>
<p>Dopo che il plugin è installato, possiamo controllare il code coverage della nostra applicazione blog come segue:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests<span class="w"> </span>--cov<span class="o">=</span>blog
</code></pre></div>
<p>Dovremmo vedere qualcosa di simile:</p>
<div class="highlight"><pre><span></span><code>----------<span class="w"> </span>coverage:<span class="w"> </span>platform<span class="w"> </span>darwin,<span class="w"> </span>python<span class="w"> </span><span class="m">3</span>.10.1-final-0<span class="w"> </span>----------
Name<span class="w">               </span>Stmts<span class="w">   </span>Miss<span class="w">  </span>Cover
--------------------------------------
blog/__init__.py<span class="w">       </span><span class="m">0</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">100</span>%
blog/app.py<span class="w">           </span><span class="m">25</span><span class="w">      </span><span class="m">1</span><span class="w">    </span><span class="m">96</span>%
blog/commands.py<span class="w">      </span><span class="m">16</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">100</span>%
blog/models.py<span class="w">        </span><span class="m">57</span><span class="w">      </span><span class="m">1</span><span class="w">    </span><span class="m">98</span>%
blog/queries.py<span class="w">       </span><span class="m">12</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">100</span>%
--------------------------------------
TOTAL<span class="w">                </span><span class="m">110</span><span class="w">      </span><span class="m">2</span><span class="w">    </span><span class="m">98</span>%
</code></pre></div>
<p>Il 98% è un buon risultato, ma dobbiamo sempre ricordarci che un'alta percentuale di copertura èp buyona, ma la qualità dei nostri test è molto più importante. Se soltanto il 70% o meno del codice è coiperto, dovremmo pensare a come aumentare la percentuale di copertura; in generale, però, non ha senso scrivere test che vadano dal 98 al 100$ (di nuovo, i test devono essere mantenuti proprio come la nostra logica di business).</p>
<h2 id="test-end-to-end">Test end-to-end<a class="headerlink" href="#test-end-to-end" title="Permanent link">&para;</a></h2>
<p>Abbiamo un'API funzionante a questo punto che è completamente testata. Possiamo adesso guardare a come scrivere dei test end-to-end (e2e). Dal momento che abbiamo una semplice API, possiamos crivere un singolo test e2e per coprire il seguente scenario:</p>
<ul>
<li>creare un nuovo articolo</li>
<li>redigere la lista degli articoli</li>
<li>ottenere il primo articolo della lsita</li>
</ul>
<p>Per prima cosa, installiamo la libreria requests:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>requests
</code></pre></div>
<p>A  questo punto, aggiungiamo un nuovo test a <code>test_app.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="c1"># other code ...</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">e2e</span>
<span class="k">def</span> <span class="nf">test_create_list_get</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;http://localhost:5000/create-article/&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;john@doe.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;New Article&quot;</span><span class="p">,</span>
            <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Some extra awesome content&quot;</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;http://localhost:5000/article-list/&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">articles</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;http://localhost:5000/article/</span><span class="si">{</span><span class="n">articles</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</code></pre></div>
<p>Ci sono due cose che dobbiamo fare prima di eseguire questo test. Per prima cosa, registriamo un marker chiamato e2e con pytest aggiungendo il seguente codice a <code>pytest.ini</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">[pytest]</span>
<span class="na">markers</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="na">e2e</span><span class="o">:</span><span class="w"> </span><span class="s">marks tests as e2e (deselect with &#39;-m &quot;not e2e&quot;&#39;)</span>
</code></pre></div>
<p>I marker pytest sono usati per escludere dei test dall'esecuzione, o per includere i test selezionati indipendentemente dalla loro posizione.</p>
<p>Per eseguire soltanto i test e2e, eseguiamo:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;e2e&#39;</span>
</code></pre></div>
<p>Per eseguire tutti i test ad eccezione degli e2e:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;not e2e&#39;</span>
</code></pre></div>
<p>I test e2e sono più costosi da eseguire e richiedono che l'app sia configurata ed in esecuzione, per cui probabilmente non vorremo eseguirli sempre.</p>
<p>Dal momento che i nostri test e2e vanno a riguardare un server live, dovremo lanciare l'app. Navighiamo nel progetto in un nuovo terminale, attiviamo l'am,biente virtuale, ed esegfuiamo l'app:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span><span class="nv">FLASK_APP</span><span class="o">=</span>blog/app.py<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>flask<span class="w"> </span>run
</code></pre></div>
<p>Adesso possiamo eseguire il nostro test e2e:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;e2e&#39;</span>
</code></pre></div>
<p>Dovremmo vedere un errore 500. Perché? Non è passato l'unit test? Sì. Il problema è che non abbiamo creato la tabella del database. Abbiamo suato delle fixture per questo nei nostri test che lo fanno per noi. Creiamo quindi una tabella ed un datrabase.</p>
<p>Aggiungiamo un file <code>inti_db.py</code> nella cartella <em>blog</em>:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">blog.models</span> <span class="kn">import</span> <span class="n">Article</span>
    <span class="n">Article</span><span class="o">.</span><span class="n">create_table</span><span class="p">()</span>
</code></pre></div>
<p>Eseguiamo il nuovo script e lanciamo di nuovo il server:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>python<span class="w"> </span>blog/init_db.py
<span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span><span class="nv">FLASK_APP</span><span class="o">=</span>blog/app.py<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>flask<span class="w"> </span>run
</code></pre></div>
<p>Se abbiamo dei problemi nell'eseguire <code>init_db.py</code>, dovremmo voler impostare il pathg Python:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">PYTHONPATH</span><span class="o">=</span><span class="nv">$PYTHONPATH</span>:<span class="nv">$PWD</span>.
</code></pre></div>
<p>I test dovrebbero adesso passare.</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>tests<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;e2e&#39;</span>
</code></pre></div>
<h2 id="testing-pyramid">Testing Pyramid<a class="headerlink" href="#testing-pyramid" title="Permanent link">&para;</a></h2>
<p>Abbiamo iniziato con gli unit test (per testare i comandi e le query) seguiti dagli integration test (per testare gli endpoint), ed abbiamo finito con i test e2e. In semplici applicazioni, come in questo esempio, possiamo finire con un unmero simile di unit ed integration test. In generale, maggiore è la complessità, più dovremmo vedere una forma simile ad una piramide in termini della relazione tra unit, integration e test e2e. Qui è da dove viene il termine "test pyramid".</p>
<p>La Test Pyramid è un framework che ci aiuta a creare del software di alta qualità.</p>
<h3 id="test-pyramid">Test Pyramid<a class="headerlink" href="#test-pyramid" title="Permanent link">&para;</a></h3>
<p>Usando il concetto di Test Pyramid come guida, vogliamo tipicamente che il 50% dei test nella nostra test suite sia unit test, il 30% integration test, ed il 20% e2e test.</p>
<table>
<thead>
<tr>
<th>Tipo di test</th>
<th>Descrizione</th>
</tr>
</thead>
<tbody>
<tr>
<td>Unit test</td>
<td>Testa una singola unità di codice</td>
</tr>
<tr>
<td>Integration test</td>
<td>Testa che più unità lavorino insieme</td>
</tr>
<tr>
<td>Test e2e</td>
<td>Testa l'intera applicazione in un ambiente simile a quello di produzione</td>
</tr>
</tbody>
</table>
<p>Più in alto andiamo nella piramide, più BRITTLE e meno predicibili sono i nostri test. Inoltre, i test e2e sono di gran lunga i più lenti da eseguire, per cui anche se possono assicurarci che la nsotra applicazione stia facendo quello per cui ci si aspetta che funzioni, non dovremmo averne così tanti come gli unit o integration test.</p>
<h3 id="cosa-e-una-unit">Cosa è una Unit?<a class="headerlink" href="#cosa-e-una-unit" title="Permanent link">&para;</a></h3>
<p>E' semplice capire cosa sono i test e2e e quelli di integration. Vi è molta più discussione a riguardo degli unit test dal momento che dobbiamo per prima cosa definire quello che è in effetti una "unit". La maggior parte dei tutotrial ci mostra che una unit è una singola funzione o metodo. Purtroppo, il codice nei casi reali non è quasi mai così semplice.</p>
<p>Tuttavia, prima di definire quello che è una unit, vediamo qual è il motivo per cui effettuare il test, e cosa dovrebbe essere testato.</p>
<h3 id="perche-testare">Perché testare?<a class="headerlink" href="#perche-testare" title="Permanent link">&para;</a></h3>
<p>Scriviamo dei test per:</p>
<ul>
<li>assicurarci che il nostro codice funzioni come atteso</li>
<li>proteggiamo i software contro i problemi di regressione</li>
</ul>
<p>Nonostante questo, quando i cicli di feedback sono troppo lunghi, gli sviluppatori tendono ad iniziare a pensare più sui tipi di test da scrivere dal momento che il tempo è un vincolo importante nello sviluppo software. Ecco perché vogliamo avere più unit test che altri tipi di test. Vogliamo trovare e fixare il difetto quanto prima possibile.</p>
<h2 id="cosa-testare">Cosa testare?<a class="headerlink" href="#cosa-testare" title="Permanent link">&para;</a></h2>
<p>Ora che sappiamo che cosa dobbiamo testare, dobbiamo vedere quello che stiamo testando.</p>
<p>Dovremmo testare il comportamento del nostro software. E, sì, questo si applica al TDD, non solo al BDD. Questo è il motivo per cui non dovremmo dover cambiare i nostri test ogni volta che vi è un cambio nella codebase.</p>
<p>Pensiamo di nuovo all'esempio dell'applicazione reale. Da una prospettiva di testing, non ci interessa dove gli articoli sono mermozizati. Potrebbe trattarsi di un file di testo, un database relazionale, un insieme di coppie chiave/valore - non importa. Di nuovo, l'app ha i seguenti requisiti:</p>
<ul>
<li>gli articoli possono essere creati</li>
<li>gli articoli possono essere estratti</li>
<li>gli articoli possono essere messi in lista</li>
</ul>
<p>Fino a che questi requisiti non cambiano, un cambio nel mezzo di storage non romperà i nostri test. In modo simile, sappiamo che fino a che questi test passano, sappiamo che i software rispettano i requisiti preposti, per cui sta funzionando.</p>
<h3 id="per-cui-cosa-e-ununit">Per cui cosa è un'unit?<a class="headerlink" href="#per-cui-cosa-e-ununit" title="Permanent link">&para;</a></h3>
<p>Ogni funzione/metodo è tecnicamente un'unità, ma non dobbiamo comunque testare ognuno di loro. Invece, dobbiamo focalizzarci sul test delle funzioni e metodi che sono pubblicamente esposti da un modulo/package.</p>
<p>Nel nostro caso, questi erano i metodi execute. Non ci aspettiamo di chiamare il modello Article direttamente dall'API Flask, per cui non ci focalizziamo molto sul suo test. Per essere più precisi, nel nostro caso, le "unità" che devono essere testato sono i metodi execute dai comandi e dalle query. Se alcuni metodi non devono essere chiamati direttamente da altre parti del software o da un utilizzatore finale, siamo di fronte a dettagli implementativi, probabilmente. Di conseguenza, i nostri test sono resistenti al refacotring per i dettagli implementativi, che è una delle qualità dei buoni test.</p>
<p>Ad esempio, i nostri test passano se wrappiamo la logica per <code>get_by_id</code> e <code>get_by_title</code> in un metodo protetto chiamato <em>get</em>by_attribute:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># other code ...</span>

<span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>
    <span class="n">author</span><span class="p">:</span> <span class="n">EmailStr</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_by_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">article_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_by_attribute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM articles WHERE id=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">article_id</span><span class="p">,))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_by_title</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_by_attribute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM articles WHERE title = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">title</span><span class="p">,))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_by_attribute</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sql_query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sql_query_values</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DATABASE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;database.db&quot;</span><span class="p">))</span>
        <span class="n">con</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span>

        <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_query</span><span class="p">,</span> <span class="n">sql_query_values</span><span class="p">)</span>

        <span class="n">record</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">record</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NotFound</span>

        <span class="n">article</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">record</span><span class="p">)</span>  <span class="c1"># Row can be unpacked as dict</span>
        <span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">article</span>

<span class="c1"># other code ..</span>
</code></pre></div>
<p>D'altro lato, se facciamo un breaking change all'interno di Article i test falliranno. E questo è esattamente quello che vogliamo. In questa situazione, possiamo sia invertire il breaking change, o adattarlo all'interno del nostro comando o query-</p>
<p>PErché c'è una cosa per la quale stiamo STRIVING FOR: i test che passano significa che il nostro software funziona.</p>
<h2 id="quando-usare-i-mocks">Quando usare i mocks?<a class="headerlink" href="#quando-usare-i-mocks" title="Permanent link">&para;</a></h2>
<p>Non abbiamo usato dei mocks nei nostri test, perché non ne abbiamo avuto bisogno. I metodi di mocking o le classi all'interno dei moduli o package producono dei test che non sono resistenti al refactoring perché sono accoppiati ai dettagli implementativi. Questi test si "rompono" spesso e sono costosi da manuentere. D'altro canto, ha senso effettuare il mock di risorse esterne quando la velicità è un problema (chiamata ad API eterne, invio di email, processi asincroni lunghi, etc.).</p>
<p>Per esempio, possiamo testare il modello Article separatamente, ed effettuarne il mock all'interno dei nostri test per CreateArticleCommand come segue:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_create_article</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GIVEN CreateArticleCommand with valid properties author, title and content</span>
<span class="sd">    WHEN the execute method is called</span>
<span class="sd">    THEN a new Article must exist in the database with same attributes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="p">(</span>
        <span class="n">author</span><span class="o">=</span><span class="s2">&quot;john@doe.com&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;New Article&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;Super awesome article&quot;</span>
    <span class="p">)</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
        <span class="n">Article</span><span class="p">,</span>
        <span class="s2">&quot;save&quot;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="n">article</span>
    <span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">CreateArticleCommand</span><span class="p">(</span>
        <span class="n">author</span><span class="o">=</span><span class="s2">&quot;john@doe.com&quot;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;New Article&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="s2">&quot;Super awesome article&quot;</span>
    <span class="p">)</span>

    <span class="n">db_article</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">db_article</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">article</span><span class="o">.</span><span class="n">id</span>
    <span class="k">assert</span> <span class="n">db_article</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="n">article</span><span class="o">.</span><span class="n">author</span>
    <span class="k">assert</span> <span class="n">db_article</span><span class="o">.</span><span class="n">title</span> <span class="o">==</span> <span class="n">article</span><span class="o">.</span><span class="n">title</span>
    <span class="k">assert</span> <span class="n">db_article</span><span class="o">.</span><span class="n">content</span> <span class="o">==</span> <span class="n">article</span><span class="o">.</span><span class="n">content</span>
</code></pre></div>
<p>Sì, questo è perfettamente ok da fare, ma adesso abbiamo più test da manutenere -- ovvero, tutti i test di prima più tutti i nuovi test per i metodi in Article. Oltre questo, l'unica cosa che è adesso testata da test<em>create</em>article è che un articlo restituito dal metodo save è lo stesso di quelli restituiti da exeute. Quando rompiamo qualcosa all'interno di Article questo test passerà comunque perché ne abbiamo fatto il mocking. E questo è qualcosa che vogliamo evitare: vogliamo testare il comportamento del software per assicurarci che funzionasse come atteso. In questo caso, il comportamento è rotto ma i nostri test non lo mostreranno.</p>
<h2 id="pensieri-finali">Pensieri finali<a class="headerlink" href="#pensieri-finali" title="Permanent link">&para;</a></h2>
<p>Non c'è un singolo modo giusto per testare il nostro software. Inoltre, è più facile testare la logica quando non è accoppiata con il nostro database. Possiamo in tal senso usare il pattern Active Record with command adn queries (CQRS) per aiutarci in tal senso.</p>
<p>E' opportuno focalizzarci sul valore di business del nostro codice.</p>
<p>Non testiamo i metodi giusto per dire che sono stati testati. Abbiamo bisogno di software funzionale, non meotdi testati. Il TDD è semplicemente un tool per dare software migliore più velocemente ed in maniera più affidabile. Lo stesso si può dire per la copertura del codice: proviamo a mantenerla alta, ma non dobbiamo necessariamente aggiungere test semplicemente per averla al 100%.</p>
<p>Un test ha valore soltanto quando ci protegge dalla regressione, ci permette il refacoring ,e ci offre un feedback rapido. Quindi, dovremmo fare in modo che i test assomiglino ad una forma piramidale (50% unit, 30% integraiton, 20% e2e). Questo anche se in applicazioni semplici può sembrare più una casa (40 unit, 40 integration, 20 e2e), il che va comunque bene.</p>
<p>Più rapidamente notiamo la regressione, più velocemente possiamo intercettarla e correggerla. Più velocemente la correggiamo, più breve è il ciclo di sviluppo. Per avere feedback più rapidi, possiamo usare i marker di pytest per escludere e2e ed altri test lenti durante lo sviluppo. Possiaom eseguirli meno frequentemente.</p>
<p>Usiamo i mock solo quanod necessario, come per le API di terze parit. Questi rendono il setup dei nostri test più complicati ed i test meno resistenti al refactoring. Inoltre, possono risultare in falsi positivi.</p>
<p>Di nuvoo, i test sono una vulnerabilitùà e non un asset: dovremmo coprire il comportamento del software, ma non crearne un numero eccessivo.</p>
<h3 id="conclusione">Conclusione<a class="headerlink" href="#conclusione" title="Permanent link">&para;</a></h3>
<p>C'è molto da digerire qui. Teniamo a mente che questi sono solo esempi usati per mostrare le idee. Possiamo usare le stesse idee con il Domain-driven design (DDD), il Behavior-Driven design (BDD), e molti altri approcci. Teniamo a mente che i test dovrebbero essere trattati come altro codice: sono una vulnerabilità, e non una risorsa. Scriviamo i test per proteggere i software dai bug, ma non permettiamo loro di bruciare il nostro tempo.</p>


  




                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; Angelo Cardellicchio - MIT License
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/anhelus" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:angelo.cardellicchio@poliba.it" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.7l167.6-182.9c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copiato", "clipboard.copy": "Copia", "search.result.more.one": "1 altro in questa pagina", "search.result.more.other": "# altri in questa pagina", "search.result.none": "Nessun documento trovato", "search.result.one": "1 documento trovato", "search.result.other": "# documenti trovati", "search.result.placeholder": "Scrivi per iniziare a cercare", "search.result.term.missing": "Non presente", "select.version": "Seleziona la versione"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.aecac24b.min.js"></script>
      
        <script src="../../../js/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>