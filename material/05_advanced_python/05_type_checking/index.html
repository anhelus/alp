
<!doctype html>
<html lang="it" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.7">
    
    
      
        <title>Type checking - Informatica per l'Ingegneria (classe N)</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.4b4a2bd9.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-J2XESD8WDV"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-J2XESD8WDV",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-J2XESD8WDV",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#type-checking" class="md-skip">
          Vai al contenuto
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Intestazione">
    <a href="../../.." title="Informatica per l&#39;Ingegneria (classe N)" class="md-header__button md-logo" aria-label="Informatica per l'Ingegneria (classe N)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Informatica per l'Ingegneria (classe N)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Type checking
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Cerca" placeholder="Cerca" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Cerca">
        
        <button type="reset" class="md-search__icon md-icon" title="Cancella" aria-label="Cancella" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inizializza la ricerca
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigazione" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Informatica per l&#39;Ingegneria (classe N)" class="md-nav__button md-logo" aria-label="Informatica per l'Ingegneria (classe N)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Informatica per l'Ingegneria (classe N)
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home del corso
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../01_intro/01_introduction/lecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1 - Introduzione all'informatica
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../01_intro/02_algorithms/lecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2 - Introduzione agli algoritmi
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../01_intro/03_dec_bin/lecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3 - Numeri decimali e binari
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../01_intro/04_data_type/lecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4 - Tipi di dato
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../01_intro/05_flow_chart/lecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5 - Diagrammi di flusso
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../01_intro/06_structured/lecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6 - Programmazione strutturata
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../01_intro/07_variables/lecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7 - Variabili
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../01_intro/08_functions/lecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8 - Funzioni
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    9 - Complessità computazionale
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            9 - Complessità computazionale
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../01_intro/09_complexity/lecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dispense
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../01_intro/09_complexity/exercises/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Esercizi
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../01_intro/10_data_structures/lecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    10 - Strutture dati
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../01_intro/11_recursion/lecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    11 - Ricorsione
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../01_intro/12_paradigms/lecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    12 - Paradigmi di programmazione
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../01_intro/13_adv_data_structures/lecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    13 - Strutture dati avanzate
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../02_algorithms/14_sorting/selection_sort/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    14 - Selection sort
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Indice">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Indice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#linguaggi-di-programmazione-statici-vs-linguaggi-di-programmazione-dinamici" class="md-nav__link">
    Linguaggi di programmazione statici vs linguaggi di programmazione dinamici
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#type-hints" class="md-nav__link">
    Type Hints
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#type-annotation-vs-type-hints" class="md-nav__link">
    Type annotation vs type hints
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#il-modulo-typing" class="md-nav__link">
    Il modulo typing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#static-type-checking-con-mypy" class="md-nav__link">
    Static Type Checking con mypy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#type-checking-a-runtime" class="md-nav__link">
    Type Checking a runtime
  </a>
  
    <nav class="md-nav" aria-label="Type Checking a runtime">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pydantic" class="md-nav__link">
    pydantic
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#marshmallow" class="md-nav__link">
    Marshmallow
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#typeguard" class="md-nav__link">
    Typeguard
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flask-con-pydantic" class="md-nav__link">
    Flask con pydantic
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eseguire-i-type-checker" class="md-nav__link">
    Eseguire i type checker
  </a>
  
    <nav class="md-nav" aria-label="Eseguire i type checker">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#allinterno-della-nostra-ide" class="md-nav__link">
    All'interno della nostra IDE
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pre-commit-hooks" class="md-nav__link">
    Pre-commit Hooks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ci-pipeline" class="md-nav__link">
    CI Pipeline
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#a-runtime" class="md-nav__link">
    A runtime
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusioni" class="md-nav__link">
    Conclusioni
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="type-checking">Type checking<a class="headerlink" href="#type-checking" title="Permanent link">&para;</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Cosa è il type checking? Perché ne abbiamo bisogno? Qual è la differentra tra type checking statico ed a runtime?</p>
</div>
<p>Python è un linguaggio <em>fortemente tipizzato</em> e che sfrutta la <em>programmazione dinamica</em>. In particolare, è <em>tipizzato in maniera dinamica</em>: in pratica, i tipi sono inferiti dinamicamente, per cui possiamo imostare i valori di una vairbabile direttamente senza definirne il tipo come nei linguaggi di programmazione tipizzati staticamente come Java.</p>
<p>What is type checking? Why do we need it? What's the difference between static and runtime type checking?</p>
<h2 id="linguaggi-di-programmazione-statici-vs-linguaggi-di-programmazione-dinamici">Linguaggi di programmazione statici vs linguaggi di programmazione dinamici<a class="headerlink" href="#linguaggi-di-programmazione-statici-vs-linguaggi-di-programmazione-dinamici" title="Permanent link">&para;</a></h2>
<p>I termini <em>forte</em> e <em>dinamico</em> indicano che i tipi sono inferiti a runtime, ma non possono essere tra loro mescolati. Ad esempio, <code>a = 1 + '0'</code> ci mostrerà un errore. D'altro canto, JavaScript è debolmente tipizzato e dinamico, per cui i tipi sono inferiti a runtime e pososno essere mescolati. Ad esempio, <code>a = 1 + '0'</code> ci darà 10 come risultato.</p>
<p>La tipizzazione dinamica ci porta una maggiore flessibilità, ma non è sempre desiderabile, per cui ci sono stati diversi sforzi per portare l'inferenza statica nei linguaggi dinamici.</p>
<p>In questo articolo vedremo a cosa sono i <em>type hints</em> e come possono aituarci. Vedremo anche come possiamo usare il sistema di tipizzazione di Python per il type checking statico con mypy e come effettuar eil type checking a runtime con pydantic, marshmallow e typeguard.</p>
<div class="admonition note">
<p class="admonition-title">Tool per il type checking</p>
<p>Esistono numerosi strumenti che usano i type hints per il type checking statico ed a runtime. Per una lista completa, consultiamo <a href="https://github.com/typeddjango/awesome-python-typing">Awesome Python Typing</a>.</p>
</div>
<h2 id="type-hints">Type Hints<a class="headerlink" href="#type-hints" title="Permanent link">&para;</a></h2>
<p>Il concetto di type hints è stato aggiungo a Python nella versione 3.5. Questi hanno permesso aglis viluppatori di annotare i tipi <em>attesi</em> per le variabili, i parametri di funzione, ed i valori restituiti da una funzione all'interno del codice Python. Questi tipi non vengono forzati dall'interprete Python; tuttavia, offrono un certo numero di benefici. Per prima cosa, con i type hints, possiamo esprimere al meglio l'intento di ciò che è nel nostro codice, e di come utilizzarlo. Una migliore comprensione comporta meno bug.</p>
<p>Ad esempio, diciamo di avere la seguente funzione epr calcolare la temperatura media in un giorno:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">daily_average</span><span class="p">(</span><span class="n">temperatures</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">temperatures</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">temperatures</span><span class="p">)</span>
</code></pre></div>
<p>Finché forniamo una lista di temperature, la funzione lavora come previsto e restituisce il risultato atteso:</p>
<div class="highlight"><pre><span></span><code><span class="n">average_temperature</span> <span class="o">=</span> <span class="n">daily_average</span><span class="p">([</span><span class="mf">22.8</span><span class="p">,</span> <span class="mf">19.6</span><span class="p">,</span> <span class="mf">25.9</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">average_temperature</span><span class="p">)</span>  <span class="c1"># =&gt; 22.76666666666667</span>
</code></pre></div>
<p>Cosa accade se chiamiamo la funzione con un dizionario dove le chiavi sono i timestamp delle misure ed i valori sono le temperature?</p>
<div class="highlight"><pre><span></span><code><span class="n">average_temperature</span> <span class="o">=</span> <span class="n">daily_average</span><span class="p">({</span><span class="mi">1599125906</span><span class="p">:</span> <span class="mf">22.8</span><span class="p">,</span> <span class="mi">1599125706</span><span class="p">:</span> <span class="mf">19.6</span><span class="p">,</span> <span class="mi">1599126006</span><span class="p">:</span> <span class="mf">25.9</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">average_temperature</span><span class="p">)</span>  <span class="c1"># =&gt; 1599125872.6666667</span>
</code></pre></div>
<p>In pratica, questa funzione restituisce la somma delle chiavi diviso il numero dichiavi, il che è chiaramente sbagliato. Dal momento che la chiamata a funzione non ha lanciato un errore, questo potrebbe non essere individuato, specialmente se l'utente finale fornisce le temperature.</p>
<p>Per evitare questa confusione, possiamo aggiungere i type hints marcando l'argomento ed il valore di ritorno:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>


<span class="k">def</span> <span class="nf">daily_average</span><span class="p">(</span><span class="n">temperatures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">temperatures</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">temperatures</span><span class="p">)</span>
</code></pre></div>
<p>Adesso la definizione della funzione ci dice che:</p>
<ul>
<li>le temperature dovrebbero essere una lista di float: <code>temperatures: List[float]</code></li>
<li>la funzione dovrebbe restituire un float: <code>-&gt; float</code></li>
</ul>
<p>Verifichiamolo:</p>
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">daily_average</span><span class="o">.</span><span class="vm">__annotations__</span><span class="p">)</span>
<span class="c1"># {&#39;temperatures&#39;: typing.List[float], &#39;return&#39;: &lt;class &#39;float&#39;&gt;}</span>
</code></pre></div>
<p>I type hints permettono di usare dei tool di type checking statico. Le IDE li usano, mettendo in guardia l'utente quando l'uso di una certa funzione o metdono non è quello atteso sulla base dei type hint e fornendo un'ottima funzione di autocompletamento.</p>
<p>Di conmseguenza, i type hint sono nei fatti soltanto dei <em>suggerimenti</em>. Non sono vincolanti come le definizioni di tipo nei linguaggi tipizzati staticamente, in altre parole. Detto questo, anche se sono abbastanza flessibili, ci aiutano a migliorare la qualità del codice esprimendo più chiaramente le nostre intenzioni. Oltre questo possiamo usare una serie di strumenti che ci aiutano a trarne beneficio.</p>
<h2 id="type-annotation-vs-type-hints">Type annotation vs type hints<a class="headerlink" href="#type-annotation-vs-type-hints" title="Permanent link">&para;</a></h2>
<p>Le type annotation sono soltanto una sintassi per annotare gli input, output e variabili di una funzione:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">sum_xy</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="s1">&#39;an integer&#39;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="s1">&#39;another integer&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="nb">print</span><span class="p">(</span><span class="n">sum_xy</span><span class="o">.</span><span class="vm">__annotations__</span><span class="p">)</span>
<span class="c1"># {&#39;x&#39;: &#39;an integer&#39;, &#39;y&#39;: &#39;another integer&#39;, &#39;return&#39;: &lt;class &#39;int&#39;}</span>
</code></pre></div>
<p>I type hints sono costruiti "sopra" le annotation, per renderle più utili. Gli hint e le annotation sono spesso usati in maniera intercambiabile, ma in realtà sono differenti.</p>
<h2 id="il-modulo-typing">Il modulo <code>typing</code><a class="headerlink" href="#il-modulo-typing" title="Permanent link">&para;</a></h2>
<p>Potremmo chiederci perché possiamo usare il float built-in per definire il tipo di ritorno di una funzione, ma la List invece viene importata direttamente dal modulo <code>typing</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="k">def</span> <span class="nf">daily_average</span><span class="p">(</span><span class="n">temperatures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">temperatures</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">temperatures</span><span class="p">)</span>
</code></pre></div>
<p>Prima di Python 3.9, l'interprete Python non supportava l'uso di built-in come argomenti per il type hinting. Ad ese mpio, era possibile usare una list come type hint come segue:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">daily_average</span><span class="p">(</span><span class="n">temperatures</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">temperatures</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">temperatures</span><span class="p">)</span>
</code></pre></div>
<p>Ma non era possibile definire il tipo atteso degli elementi di una lista (<code>List[float]</code>) senza il modulo <code>typing</code>. Lo stesso può essere detto per i dizionari e le altre sequenze e tipi complessi:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span>

<span class="k">def</span> <span class="nf">generate_map</span><span class="p">(</span><span class="n">points</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nb">map</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</code></pre></div>
<p>Oltre questo, il modulo <code>typing</code> ci permette di defninire nuovi tipi, alias per tipi esistenti, usare il tipo <code>Any</code> e molte altre cose.</p>
<p>Ad esempio, potremmo voler permettere più tipi. In questo caso, possiamo suare una <code>Union</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="k">def</span> <span class="nf">sum_ab</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">b</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</code></pre></div>
<p>A partire da Python 3.9, possiamo usare i built-ins come segue:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">sort_names</span><span class="p">(</span><span class="n">names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
</code></pre></div>
<h2 id="static-type-checking-con-mypy">Static Type Checking con mypy<a class="headerlink" href="#static-type-checking-con-mypy" title="Permanent link">&para;</a></h2>
<p><a href="#">mypy</a> è un tool per il type checking a compile time. Possiamo installarlo come ogni altro package Python:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>mypy
</code></pre></div>
<p>Per controllare il nostro modulo Python possiamo eseguirlo come segue:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>mypy<span class="w"> </span>my_module.py
</code></pre></div>
<p>Diamo di nuovo uno sguardo all'esempio <code>daily_average</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">daily_average</span><span class="p">(</span><span class="n">temperatures</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">temperatures</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">temperatures</span><span class="p">)</span>

<span class="n">average_temperature</span> <span class="o">=</span> <span class="n">daily_average</span><span class="p">(</span>
    <span class="p">{</span><span class="mi">1599125906</span><span class="p">:</span> <span class="mf">22.8</span><span class="p">,</span> <span class="mi">1599125706</span><span class="p">:</span> <span class="mf">19.6</span><span class="p">,</span> <span class="mi">1599126006</span><span class="p">:</span> <span class="mf">25.9</span><span class="p">}</span>
<span class="p">)</span>
</code></pre></div>
<p>Quando effettuiamo il type checking con mypy su questo codice, non ci sono errori, dal momento che la funzione non usa dei type hints:</p>
<div class="highlight"><pre><span></span><code>Success:<span class="w"> </span>no<span class="w"> </span>issues<span class="w"> </span>found<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nb">source</span><span class="w"> </span>file
</code></pre></div>
<p>Aggiungiamo i type hint:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>


<span class="k">def</span> <span class="nf">daily_average</span><span class="p">(</span><span class="n">temperatures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">temperatures</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">temperatures</span><span class="p">)</span>


<span class="n">average_temperature</span> <span class="o">=</span> <span class="n">daily_average</span><span class="p">(</span>
    <span class="p">{</span><span class="mi">1599125906</span><span class="p">:</span> <span class="mf">22.8</span><span class="p">,</span> <span class="mi">1599125706</span><span class="p">:</span> <span class="mf">19.6</span><span class="p">,</span> <span class="mi">1599126006</span><span class="p">:</span> <span class="mf">25.9</span><span class="p">}</span>
<span class="p">)</span>
</code></pre></div>
<p>Eseguiamo di nuovo <code>mypy</code>:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>mypy<span class="w"> </span>my_module.py
</code></pre></div>
<p>Dovremmo vedere un output di questo tipo:</p>
<div class="highlight"><pre><span></span><code>my_module.py:9:<span class="w"> </span>error:<span class="w"> </span>Argument<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span><span class="s2">&quot;daily_average&quot;</span><span class="w"> </span>has<span class="w"> </span>incompatible
<span class="nb">type</span><span class="w"> </span><span class="s2">&quot;Dict[int, float]&quot;</span><span class="p">;</span><span class="w"> </span>expected<span class="w"> </span><span class="s2">&quot;List[float]&quot;</span>

Found<span class="w"> </span><span class="m">1</span><span class="w"> </span>error<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>file<span class="w"> </span><span class="o">(</span>checked<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nb">source</span><span class="w"> </span>file<span class="o">)</span>
</code></pre></div>
<p>mypy ha riconosciuto che la funzione era chiamata in maniera non corretta. Aveva riportato il nome del file, il numero di linea, e la descrizione dell'errore. Usare i type hint assieme a mypy può aiutare a ridurre il numero di errori risultanti dall'uso sbagliato di funzioni, metodi, e classi. Questo risulta in loop di feedback più rapidi. Non abbiamo bisogno di eseguire tutti i nostri test o effettuare il deploy dell'intera applicazione. Siamo notificati di questi errori immediatamente.</p>
<p>E' anche una buona idea aggiungere mypy alla nostra CI pipeline, così come effetutare il type checking prima che sia fatto il merge o il deploy del nostro codice, come abbiamo detto nell'<a href="../04_code_quality/">articolo sulla qualità del codice Python</a>.</p>
<p>Anche se rappresenta un grosos miglioramento in termini di qualità del codice, il type chekcing statico non forza i tipi a runtime. Questo è il motivo per cui abbiamop anche dei type checker a runtime, che vedremo a brevev.</p>
<p>mypy contiene anche typeshed, che contiene delle annotazioni di tipo esterne per la libreria standard Python e per i tipi integrati in Python, così come package di terze parti.</p>
<p>mypy controlla i programmi Python senza alcun overhead a runtime. Anche se controlla i tipi, il duck typing è sempre valido. Quindi, non può essere usato per compilare le estensioni CPython.</p>
<h2 id="type-checking-a-runtime">Type Checking a runtime<a class="headerlink" href="#type-checking-a-runtime" title="Permanent link">&para;</a></h2>
<h3 id="pydantic">pydantic<a class="headerlink" href="#pydantic" title="Permanent link">&para;</a></h3>
<p>I type checker statici non ci aiutano con i dati da sorgenti esterne come gli utenti della nostra applciazione. Qui è dove i runtime type checker entrano in gioco. Un tool per far questo è <a href="#">pydantic</a>, che viene usato per validare i dati. Lancia un errore di validazione quando i dati forniti non combaciano con un tipo definito con un type hint.</p>
<p>pydantic usa il type casting per convertire i dati di input per forzarlo a conformarsi al tipo atteso.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pydantic
</code></pre></div>
<p>E' abbastanza semplice da usare. Per esempio, definiamo una classe <code>Song</code> con alcuni attributi:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>


<span class="k">class</span> <span class="nc">Song</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">release</span><span class="p">:</span> <span class="n">date</span>
    <span class="n">genres</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</code></pre></div>
<p>Ora, quando inizializziamo una nuova <code>Song</code> con dati validi, tutto funziona come atteso:</p>
<div class="highlight"><pre><span></span><code><span class="n">song</span> <span class="o">=</span> <span class="n">Song</span><span class="p">(</span>
    <span class="nb">id</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Bohemian Rhapsody&#39;</span><span class="p">,</span>
    <span class="n">release</span><span class="o">=</span><span class="s1">&#39;1975-10-31&#39;</span><span class="p">,</span>
    <span class="n">genres</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;Hard Rock&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Progressive Rock&#39;</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">song</span><span class="p">)</span>
<span class="c1"># id=101 name=&#39;Bohemian Rhapsody&#39; release=datetime.date(1975, 10, 31)</span>
<span class="c1"># genres=[&#39;Hard Rock&#39;, &#39;Progressive Rock&#39;]</span>
</code></pre></div>
<p>Tuttavia, quando proviamoa d inizializzare una nuova Song con una data non valida viene lanciato un <code>ValidationError</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">song</span> <span class="o">=</span> <span class="n">Song</span><span class="p">(</span>
    <span class="nb">id</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Bohemian Rhapsody&#39;</span><span class="p">,</span>
    <span class="n">release</span><span class="o">=</span><span class="s1">&#39;1975-31-31&#39;</span><span class="p">,</span>
    <span class="n">genres</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;Hard Rock&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Progressive Rock&#39;</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">song</span><span class="p">)</span>
<span class="c1"># pydantic.error_wrappers.ValidationError: 1 validation error for Song</span>
<span class="c1"># release</span>
<span class="c1">#   invalid date format (type=value_error.date)</span>
</code></pre></div>
<p>Con pydantic, possiamo assicurarci che soltanto i dati che combaciano con i tipi che abbiamo definito siano usati nella nostram applicazione. Questo comporta non solo meno bug, ma dovremo anche scrivere meno test. Usando strumenti come <code>pydantic</code> non dobbiamo scrivere test per i casi dove l'utente manda dei dati completamente errati. Tutto ciò viene gestito da pydantic: infatti, viene lanciato un <code>ValidationError</code>. Ad esempio, FastAPI valida le richieste e le risposte HTTP mediante <code>pydantic</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Item</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">price</span><span class="p">:</span> <span class="nb">float</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/items/&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">Item</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">create_item</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">item</span>
</code></pre></div>
<p>L'handler <code>create_item</code> si attende un payload con un nome (<code>string</code>) ed un prezzo (<code>float</code>). La risposta dovrebbe essere simile. Adesso, se c'è un problema con il payload fornito, viene subito lanciato un errore. Lanciarlo in ritardo rende più difficile effettuare il debug e determianre da dove è venuto il dato di tipo errato. Inoltre, dal momento che è gestito da pydantic, possiamo tenere i nostri handler più puliti.</p>
<p>Assieme allo sfruttare i type hiunts per la validazione dei dati possiamo anche aggiungere dei validator custom per assicurare la correttezza dei dati oltre al loro tipo. Aggiungere una validazione custom per un attirbuto è abbastanza semplice. Per esempio, per prevenire i duplicati di genere nella classe <code>Song</code>, possiamo aggiugnere una validazione come segue:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">validator</span>


<span class="k">class</span> <span class="nc">Song</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">release</span><span class="p">:</span> <span class="n">date</span>
    <span class="n">genres</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;genres&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">no_duplicates_in_genre</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;No duplicates allowed in genre.&#39;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>


<span class="n">song</span> <span class="o">=</span> <span class="n">Song</span><span class="p">(</span>
    <span class="nb">id</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Bohemian Rhapsody&#39;</span><span class="p">,</span>
    <span class="n">release</span><span class="o">=</span><span class="s1">&#39;1975-10-31&#39;</span><span class="p">,</span>
    <span class="n">genres</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;Hard Rock&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Progressive Rock&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Progressive Rock&#39;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">song</span><span class="p">)</span>
<span class="c1"># pydantic.error_wrappers.ValidationError: 1 validation error for Song</span>
<span class="c1"># genre</span>
<span class="c1">#   No duplicates allowed in genre. (type=value_error)</span>
</code></pre></div>
<p>Per cui il metodo di validazione, <code>no_duplicates_in_genre</code>, deve essere decorato con un validator, che prende il nome dell'attributo come argomento. Il metodo di validazione deve essere un meotod di classe dal momento che la validazione avviene prima che l'istanza sia creata. Per i dati che falliscono la validazione dovrebbe lanciare un ValueError standard.</p>
<p>Possiamo anche usare i metodi di validazioen per alterare un valore prima che avvenga la validazione. Per farlo, aggiungiamo <code>pre=True</code> ed <code>always=True</code> al decorator validator:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;genres&#39;</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<p>Per esempio potremmo convertire i generi in minuscolo come segue:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">validator</span>


<span class="k">class</span> <span class="nc">Song</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">release</span><span class="p">:</span> <span class="n">date</span>
    <span class="n">genres</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;genres&#39;</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">always</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">to_lower_case</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">genre</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>

    <span class="nd">@validator</span><span class="p">(</span><span class="s1">&#39;genres&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">no_duplicates_in_genre</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;No duplicates allowed in genre.&#39;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>


<span class="n">song</span> <span class="o">=</span> <span class="n">Song</span><span class="p">(</span>
    <span class="nb">id</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Bohemian Rhapsody&#39;</span><span class="p">,</span>
    <span class="n">release</span><span class="o">=</span><span class="s1">&#39;1975-10-31&#39;</span><span class="p">,</span>
    <span class="n">genres</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;Hard Rock&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PrOgReSsIvE ROCK&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Progressive Rock&#39;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">song</span><span class="p">)</span>
<span class="c1"># pydantic.error_wrappers.ValidationError: 1 validation error for Song</span>
<span class="c1"># genre</span>
<span class="c1">#   No duplicates allowed in genre. (type=value_error)</span>
</code></pre></div>
<p>In particolare, <code>to_lower_case</code> converte ogni elemento nella lista dei genere in minuscolo. Siccome <code>pre</code> è impostato a <code>True</code>, questo metodo è chiamato prima che pydantic validi i tipi. Tutti i generi sono convertiti in minuscolo e quindi validati con <code>no_duplicates_in_genre</code>.</p>
<p>pydantic ci offre anche dei tipi più stretti, come PositiveInt ed EmailStr, pre rendere le validazioni migliori. In tal senso, possiamo dare un'occhiata alla sezione <a href="#">Field Types</a> della documentazione.</p>
<h2 id="marshmallow">Marshmallow<a class="headerlink" href="#marshmallow" title="Permanent link">&para;</a></h2>
<p>Un altro tool degno di nota è <a href="#">marshmallow</a>, che ci aiuta a validare dati complessi e caricare o effettuare il dump di dati dao verso tipi Python nativi. Al solito, marshmallow si installa come ogni altro package Python:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>marshmallow
</code></pre></div>
<p>Come per pydantic, possiamo aggiungere la validazione di tipo ad una classe:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">post_load</span>


<span class="k">class</span> <span class="nc">Song</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="nb">id</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">release</span><span class="p">,</span>
            <span class="n">genres</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">release</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genres</span> <span class="o">=</span> <span class="n">genres</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;&lt;Song(id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">, name=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">), &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;release=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s1">, genres=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">genres</span><span class="si">}</span><span class="s1">&gt;&#39;</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">SongSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Int</span><span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Str</span><span class="p">()</span>
    <span class="n">release</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Date</span><span class="p">()</span>
    <span class="n">genres</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>

    <span class="nd">@post_load</span>
    <span class="k">def</span> <span class="nf">make_song</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Song</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>


<span class="n">external_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">101</span><span class="p">,</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Bohemian Rhapsody&#39;</span><span class="p">,</span>
    <span class="s1">&#39;release&#39;</span><span class="p">:</span> <span class="s1">&#39;1975-10-31&#39;</span><span class="p">,</span>
    <span class="s1">&#39;genres&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Hard Rock&#39;</span><span class="p">,</span> <span class="s1">&#39;Progressive Rock&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">song</span> <span class="o">=</span> <span class="n">SongSchema</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">external_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">song</span><span class="p">)</span>
<span class="c1"># &lt;Song(id=101, name=Bohemian Rhapsody), release=1975-10-31, genres=[&#39;Hard Rock&#39;, &#39;Progressive Rock&#39;]&gt;</span>
</code></pre></div>
<p>A differenza di pydantic, marshmallow non usa il type casting, per cui dobbiamo definire lo schemae la classe <em>separatamente</em>. Ad esempio, la data di uscita in <code>external_data</code> deve essere una stringa ISO. Non funziona con un oggetto di tipo <code>datetime</code>.</p>
<p>Per abilitare la deserializzazione dei dati in un oggetto di tipo <code>Song</code>, dobbiamo aggiungere un metodo decorato con il decorator <code>@post_load</code> allo schema:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">SongSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Int</span><span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Str</span><span class="p">()</span>
    <span class="n">release</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Date</span><span class="p">()</span>
    <span class="n">genres</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span> <span class="n">validate</span><span class="o">=</span><span class="n">no_duplicates</span><span class="p">)</span>

    <span class="nd">@post_load</span>
    <span class="k">def</span> <span class="nf">make_song</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Song</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>
<p>Lo schema valida i dati e se tutti i campi sono validi crea un'istanza della classe chiamando <code>make_song</code> con i dati validati.</p>
<p>Come pydantic, possiamo aggiungere delle validazioni custom per ogni attributo a partire dallo schema. Ad esempio, possiamo prevenire dei duplicati:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">marshmallow</span> <span class="kn">import</span> <span class="n">Schema</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">post_load</span><span class="p">,</span> <span class="n">ValidationError</span>


<span class="k">class</span> <span class="nc">Song</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="nb">id</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">release</span><span class="p">,</span>
            <span class="n">genres</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">release</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genres</span> <span class="o">=</span> <span class="n">genres</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;&lt;Song(id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">, name=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">), &#39;</span>
            <span class="sa">f</span><span class="s1">&#39;release=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s1">, genres=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">genres</span><span class="si">}</span><span class="s1">&gt;&#39;</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">no_duplicates</span><span class="p">(</span><span class="n">genres</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genres</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">genres</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">genre</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">genre</span> <span class="ow">in</span> <span class="n">genres</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">genre</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">genres</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">genres</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="s1">&#39;No duplicates allowed in genres.&#39;</span>
            <span class="p">)</span>


<span class="k">class</span> <span class="nc">SongSchema</span><span class="p">(</span><span class="n">Schema</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Int</span><span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Str</span><span class="p">()</span>
    <span class="n">release</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Date</span><span class="p">()</span>
    <span class="n">genres</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">fields</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span> <span class="n">validate</span><span class="o">=</span><span class="n">no_duplicates</span><span class="p">)</span>

    <span class="nd">@post_load</span>
    <span class="k">def</span> <span class="nf">make_song</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Song</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>


<span class="n">external_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">101</span><span class="p">,</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Bohemian Rhapsody&#39;</span><span class="p">,</span>
    <span class="s1">&#39;release&#39;</span><span class="p">:</span> <span class="s1">&#39;1975-10-31&#39;</span><span class="p">,</span>
    <span class="s1">&#39;genres&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Hard Rock&#39;</span><span class="p">,</span> <span class="s1">&#39;Progressive Rock&#39;</span><span class="p">,</span> <span class="s1">&#39;ProgressivE Rock&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">song</span> <span class="o">=</span> <span class="n">SongSchema</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">external_data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">song</span><span class="p">)</span>
<span class="c1"># marshmallow.exceptions.ValidationError:</span>
<span class="c1"># {&#39;genres&#39;: [&#39;No duplicates allowed in genres.&#39;]}</span>
</code></pre></div>
<p>Come possiamo vedere, possiamo sia usare pydantic sia marshmallow per assicurarci che i dati abbiano il tipo corretto man mano che la nostra applciazione viene eseguita. Il consiglio è quello di scegliere quello che più si adatta al nostro stile.</p>
<h2 id="typeguard">Typeguard<a class="headerlink" href="#typeguard" title="Permanent link">&para;</a></h2>
<p>Mentre pydantic e marshmallow si focalizzano sulla validazione e serializzazione dei dati, typeguard si focalizza sul controllo dei tipi man mano che le funzioni vengono chiamate. Mentre mypy efefttua soltanto il type checking statico, typeguard forza i tipi mentre il nostro prgramma è in esecuzione.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>typeguard
</code></pre></div>
<p>Vediamo lo stesso esempio di prima (quello della classe Song). Questa volta definiamo il suo metodo <code>__init__</code> con gli argomenti hinted:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">from</span> <span class="nn">typeguard</span> <span class="kn">import</span> <span class="n">typechecked</span>


<span class="nd">@typechecked</span>
<span class="k">class</span> <span class="nc">Song</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">release</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="n">genres</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">release</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genres</span> <span class="o">=</span> <span class="n">genres</span>


<span class="n">song</span> <span class="o">=</span> <span class="n">Song</span><span class="p">(</span>
    <span class="nb">id</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Bohemian Rhapsody&#39;</span><span class="p">,</span>
    <span class="n">release</span><span class="o">=</span><span class="n">date</span><span class="p">(</span><span class="mi">1975</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
    <span class="n">genres</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;Hard Rock&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Progressive Rock&#39;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">song</span><span class="p">)</span>
<span class="c1"># TypeError: type of argument &quot;genres&quot; must be a list; got set instead</span>
</code></pre></div>
<p>Il decorator <code>typechecked</code> può essere usato sia per classi, sia per funzioni, quando vogliamo forzare il type checking a runtime. Eseguire questo codice lancerà un <code>TypeError</code>, dal momento che i generi sono un set invece di una lista. Possiamo usare in modo simile un decorator per le funzioni:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typeguard</span> <span class="kn">import</span> <span class="n">typechecked</span>

<span class="nd">@typechecked</span>
<span class="k">def</span> <span class="nf">sum_ab</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</code></pre></div>
<p>Viene anche fornito un plugin per pytest. Per controllare i tipi per il package <code>my_package</code> mentre eseguiamo i test possiamo eseguire questo comando:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>--typeguard-packages<span class="o">=</span>my_package
</code></pre></div>
<p>Quando eseguiamo il comando con pytest non dobbiamo usare il decorator <code>@typechecked</code>. Di conseguenza, possiamo o decorare le nostre funzioni e classi per forzare i tipi a runtime oppure semplicemente durante l'esecuzione dei test. Ad ogni modo, typeguard può essere una rete di salvezza per la nostra applicazione, in modo da assicurarci che venga eseguita come ci si aspetta.</p>
<h2 id="flask-con-pydantic">Flask con pydantic<a class="headerlink" href="#flask-con-pydantic" title="Permanent link">&para;</a></h2>
<p>Mettiamo insieme i diversi pezzi in un'applicazione web. Come detto prima, FastAPI usa pydantic di default. Anche se Flask non ha il supporto integrato di default per ppydantic, possiamo usare dei buinding per aggiungerlo alle nostre API. Creiamo quindi un nuovo progetto Flask per vederlo in azione.</p>
<p>Per prima cosa, creiamo una nuova cartella:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mkdir<span class="w"> </span>flask_example
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>flask_example
</code></pre></div>
<p>Quindi, inizializziamo il nostro progetto con Pipenv:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pipenv<span class="w"> </span>install<span class="w"> </span>flask<span class="w"> </span>Flask-Pydantic
$<span class="w"> </span>pipenv<span class="w"> </span>isntall<span class="w"> </span>-d<span class="w"> </span>pytest
</code></pre></div>
<p>Creiamo un file per i nostri test e chiamiamolo <code>test_app.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">client</span><span class="p">():</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;TESTING&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">client</span>


<span class="k">def</span> <span class="nf">test_create_todo</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;/todos/&quot;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Wash the dishes&#39;</span><span class="p">,</span>
                <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;deadline&#39;</span><span class="p">:</span> <span class="s1">&#39;2020-12-12&#39;</span>
            <span class="p">}</span>
        <span class="p">),</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>


<span class="k">def</span> <span class="nf">test_create_todo_bad_request</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;/todos/&quot;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Wash the dishes&#39;</span><span class="p">,</span>
                <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;deadline&#39;</span><span class="p">:</span> <span class="s1">&#39;WHENEVER&#39;</span>
            <span class="p">}</span>
        <span class="p">),</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
</code></pre></div>
<p>Qui abbiamo due test per creare nuovi todo. Uno controlla che  lo stato di <code>201</code> sia restituito quando tutto va bene. Un altro controlla che lo status <code>400</code> sia restituito quando i dati forniti non sono quelli attesi. </p>
<p>Quindi, aggiungiamo un file per l'app Flask chiamato <code>app.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">flask_pydantic</span> <span class="kn">import</span> <span class="n">validate</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CreateTodo</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">done</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">deadline</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span>


<span class="k">class</span> <span class="nc">Todo</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">done</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">deadline</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/todos/&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@validate</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">CreateTodo</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">todos</span><span class="p">():</span>
    <span class="n">todo</span> <span class="o">=</span> <span class="n">Todo</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">body_params</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="n">done</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">body_params</span><span class="o">.</span><span class="n">done</span><span class="p">,</span>
        <span class="n">deadline</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">body_params</span><span class="o">.</span><span class="n">deadline</span><span class="p">,</span>
        <span class="n">created_at</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">todo</span><span class="p">,</span> <span class="mi">201</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<p>Abbiamo definito un endpoint per creare i todo assieme ad uno schema di richieste chiamato <code>CreateTodo</code> ed uno di risposte chiamato <code>Todo</code>. Ora, quando i dati sono mandati all'API che non rispetta lo schema della richiest,a uno status di <code>400</code> con errori di validazione nel corpo viene restituito. Possiamo eseguire i test per controllare che l'API si stia comportando come descritto:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>pytest
</code></pre></div>
<h2 id="eseguire-i-type-checker">Eseguire i type checker<a class="headerlink" href="#eseguire-i-type-checker" title="Permanent link">&para;</a></h2>
<p>Ora che conosciamo gli strumenti, la domanda è: quando usarli?</p>
<p>In maneira simile ai tool di controllo di qualità del codice, tipicamente eseguiamo i type checker:</p>
<ul>
<li>quando stiamo programmando (all'interno quindi della nostra IDE);</li>
<li>al momento della commit (mediante gli hook pre-commit);</li>
<li>quando il codice viene mandato su una repository (mediante una pipeline di CI);</li>
<li>durante l'esecuzione del nostro programma (a runtime).</li>
</ul>
<h3 id="allinterno-della-nostra-ide">All'interno della nostra IDE<a class="headerlink" href="#allinterno-della-nostra-ide" title="Permanent link">&para;</a></h3>
<p>E' bene controallare problemi che possano avere un impatto negativo sulla qualità del codice spesso. QUindi, è raccomadnato effettuare il check statico del codice durante lo sviluppo. Molte delle IDE più popolari hanno dei type checkers simili a mypy (o mypy stesso) già integrati. Per quelle che non li hanno, vi è probabilmente un plugin disponibile. Questi plugin ci avvertono in tempo reale su eventuali violazioni di tipo e potenziali errori di programmazione.</p>
<h3 id="pre-commit-hooks">Pre-commit Hooks<a class="headerlink" href="#pre-commit-hooks" title="Permanent link">&para;</a></h3>
<p>Dal momento che inevitabilmente ci perderemo qualche warning mentre stiamo programmando, è una buona pratica controllare problemi sui tipi al momento della commit mediante dei pre-commit hooks. In questo modo possiamoe vitare di effettaure la commit di codice che non passerà i type check all'interno della nostra pipeline di CI.</p>
<p>Il framework pre-commit è quello raccomandato per la gestione dei git hooks:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pre-commit
</code></pre></div>
<p>Una volta installato, aggiungiamo un file di cofnigurazione pre-commit chiamato <code>.pre-commit-config.yaml</code> al nostro progetto. Per eseguire mypy, aggiungiamo la seguente configurazione:</p>
<div class="highlight"><pre><span></span><code><span class="nt">repos</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/pre-commit/mirrors-mypy</span>
<span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;v0.790&#39;</span>
<span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mypy</span>
</code></pre></div>
<p>Infine, per impostare gli script di git hook:</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>venv<span class="o">)</span>$<span class="w"> </span>pre-commit<span class="w"> </span>install
</code></pre></div>
<p>Adesso, ogni volta che eseguiamo <code>git commit</code> mypy verrà eseguito prima della commit vera e propria. E se vi sono dei problemi la commit verrà annullata.</p>
<h3 id="ci-pipeline">CI Pipeline<a class="headerlink" href="#ci-pipeline" title="Permanent link">&para;</a></h3>
<p>Ha senso eseguire il type check statico all'interno della nostra pipeline CI per prevenire che problemi sui tipi siano portati nella code base. Questo è probabilmente il momento più importante per eseguire mypy o altre tecniche di type checking statico.</p>
<p>Potremmo avere dei problemi quando eseguiamo i type check statici con mypy, specialmente quando usiamo librerie di terze parti senza dei type hints. Probabilmente questa è la ragione principale per la quale molti evitano di effettuare dei controlli con mypy all'interno della pipeline di CI.</p>
<h3 id="a-runtime">A runtime<a class="headerlink" href="#a-runtime" title="Permanent link">&para;</a></h3>
<p>Per il tipe checking dinamico abbiamo bisogno di un programma effettivamente in esecuzione. Come detto prima, usare dei type checker di questo tipo richiede meno test, produce meno bug, e ci aiuta ad inidividuarli prima. Possiamo usarli per la validazione dei dati (con pydantic e marshmallow) e pèer forzare i tipi durante l'esecuzione dle porogramma (con typeguard).</p>
<h2 id="conclusioni">Conclusioni<a class="headerlink" href="#conclusioni" title="Permanent link">&para;</a></h2>
<p>Il type checking potrebbe sembrare non necessario quando si ha una ridotta code base, ma man mano che aumenta di dimensioni, più importante diventa. E' uno strato utleriore che ci protegge da bug facilmente prevenibili. I type hints, anche se non sono forzati dall'interprete, ci aiutano ad esprimere al meglio lo scopo di una variabile, funzione, o classe. La maggior parte delle IDE moderne fornisce dei plugin per avvisare gli sviluppatori di problemi sui tipi sulla base dei type hiunts. Per forzarli, possiamo includere  mypy nel nostro workflow per controllare in maniera statica se l'uso dei metodi combacia con i loro type hints. Anche se l'analisi statica può migliorare il nsotro codice, dobbiamo tener conto che il nostro software sta comunicando con il mondo esterno. Di consegeunza, è preferibile aggiungere dei type checker dinamici a runtime come pydantic o marshmallow. Questi ci aiuteranno a validare l'input dell'utente e lancaire gli errori il prima possibile. Più rapidamente troviamo un errore, più facile è correggerlo.</p>


  




                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; Angelo Cardellicchio - MIT License
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/anhelus" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:angelo.cardellicchio@poliba.it" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.7l167.6-182.9c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copiato", "clipboard.copy": "Copia", "search.result.more.one": "1 altro in questa pagina", "search.result.more.other": "# altri in questa pagina", "search.result.none": "Nessun documento trovato", "search.result.one": "1 documento trovato", "search.result.other": "# documenti trovati", "search.result.placeholder": "Scrivi per iniziare a cercare", "search.result.term.missing": "Non presente", "select.version": "Seleziona la versione"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.aecac24b.min.js"></script>
      
        <script src="../../../js/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>