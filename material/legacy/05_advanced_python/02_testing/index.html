
<!doctype html>
<html lang="it" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.5">
    
    
      
        <title>02 - Test del codice Python - Informatica per l'Ingegneria (classe N)</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.50c56a3b.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-J2XESD8WDV"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-J2XESD8WDV",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-J2XESD8WDV",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#02-test-del-codice-python" class="md-skip">
          Vai al contenuto
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Intestazione">
    <a href="../../../.." title="Informatica per l&#39;Ingegneria (classe N)" class="md-header__button md-logo" aria-label="Informatica per l'Ingegneria (classe N)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Informatica per l'Ingegneria (classe N)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              02 - Test del codice Python
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Cerca" placeholder="Cerca" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Cerca">
        
        <button type="reset" class="md-search__icon md-icon" title="Cancella" aria-label="Cancella" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inizializza la ricerca
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigazione" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="Informatica per l&#39;Ingegneria (classe N)" class="md-nav__button md-logo" aria-label="Informatica per l'Ingegneria (classe N)" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Informatica per l'Ingegneria (classe N)
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home del corso
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tracce di esame svolte
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Tracce di esame svolte
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../exams/17_01_2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Traccia del 17 gennaio 2024
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Algoritmi di ordinamento
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Algoritmi di ordinamento
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../xx_sorting/01_selection_sort/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Selection sort
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Indice">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Indice
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#021-pytest" class="md-nav__link">
    <span class="md-ellipsis">
      02.1 - pytest
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mocking" class="md-nav__link">
    <span class="md-ellipsis">
      mocking
    </span>
  </a>
  
    <nav class="md-nav" aria-label="mocking">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#code-coveratge" class="md-nav__link">
    <span class="md-ellipsis">
      code coveratge
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mutation-testging" class="md-nav__link">
    <span class="md-ellipsis">
      mutation testging
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#todo-da-hypothesis" class="md-nav__link">
    <span class="md-ellipsis">
      TODO: DA HYPOTHESIS
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#type-checking" class="md-nav__link">
    <span class="md-ellipsis">
      type checking
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusioni" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusioni
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="02-test-del-codice-python">02 - Test del codice Python<a class="headerlink" href="#02-test-del-codice-python" title="Permanent link">&para;</a></h1>
<p>Il test automatico del codice è sempre stato un topic centrale nello sviluppo del software, ed ha raggiunto una sempre maggior centralità con l'arrivo di paradigmi come la <em>CI/CD</em>. In tal senso, il linguaggio Python consta di numerosi strumenti che possono aiutarci a scrivere ed eseguire test di tutti i tipi; in questo articolo, ne vedremo alcuni tra i più conosciuti ed utilizzati.</p>
<h2 id="021-pytest">02.1 - pytest<a class="headerlink" href="#021-pytest" title="Permanent link">&para;</a></h2>
<p>Di suo, la libreria standard Python integra un framework di unit test chiamato <a href="https://docs.python.org/3/library/unittest.html"><code>unittest</code></a>; tuttavia, lo standard <em>de facto</em> è la libreria <a href="https://pytest.org/"><code>pytest</code></a>, che ha cinque punti di forza:</p>
<ol>
<li><strong>minor quantità di codice boilerplate</strong>, rendendo quindi le librerie meno "verbose" e, complessivamente, più leggibili;</li>
<li><strong>supporto all'istruzione <code>assert</code></strong>, che risulta essere molto più leggibile e facile da utilizzare se comparata a metodi come <code>assertEquals</code>, <code>assertTrue</code> o <code>assertContains</code> contenuti in <code>unittest</code>;</li>
<li><strong>aggiornamento costante</strong>, dal momento che è una libreria open source a sé stante, mentre <code>unittest</code> è parte integrante di Python;</li>
<li><strong>semplificazione del setup e del teardown</strong> dei casi di test con il sistema di <em>fixture</em>;</li>
<li><strong>uso di un approccio orientato alla programmazione funzionale</strong>.</li>
</ol>
<p><code>pytest</code> ci permette inoltre di avere uno stile di testing <em>coerente</em> tra i nostri diversi progetti Python. Immaginiamo, ad esempio, di avere due web app nel nostro stack, una creata mediante Django, e l'altra mediante Flask. Senza <code>pytest</code>, probabilmente, dovremo utilizzare il framework interno di Djano per l'unit testing per la prima, ed un'estensione Flask apposita, come Flask-Testing, per la seconda: di conseguenza, le due test suite avranno stili differenti. Usando <code>pytest</code>, invece, entrambe le test suite avranno uno stile <em>consistente</em>, rendendo semplice il saltare dall'una all'altra.</p>
<p><code>pytest</code> offre anche un ecosistema di plugin molto esteso ed interamente mantenuto dalla community. Ad esempio, esiste il plugin <a href="https://pytest-django.readthedocs.io/"><code>pytest-django</code></a>, che fornisce strumenti specificamente pensati per il test di web app Django, oppure anche <a href="https://pytest-cov.readthedocs.io/"><code>pytest-cov</code></a>, utile ad integrare il supporto al code coverage.</p>
<h2 id="mocking">mocking<a class="headerlink" href="#mocking" title="Permanent link">&para;</a></h2>
<p>I test automatizzati devono essere veloci, isolati, indipendenti, deterministici e ripetiovili. Quindi, se dobbiamo testare del codice che fa una chiamata HTTP esterna ad una API di terze parti, dobbiamo effettuare il mocking della richiesta. QPErché? se non lo facciamo, i test specifici saranno:</p>
<ol>
<li>lenti perché stanno facendo delle richieste HTTP nella rete</li>
<li>dipendono dal servizio di terze parti e dalla velocità della rete stessa</li>
<li>non sono deterministici dal momento che il test puòd are un risultato differnete basato sula risposta dalla API</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>E' una buona idea anche effettuare il mocking di altre operazioni lunghe, come query al database e task asinmcrone, dal momento che i test automatizzati sono generalmente eseguiti frequente,ente, su ogni commit pushata al source control.</p>
</div>
<p>Il mocking è la pratica di rimpiazzare oggetti reali con oggetti simulati che mimano il loro comportamento a runtime. Per cui, invece da mandare una vera richiesta HTTP sula rete, ci limitiamo a restituire le risposte attes equando il metodo simulato viene chiamato.</p>
<p>Ad esempio:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="k">def</span> <span class="nf">get_my_ip</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;http://ipinfo.io/json&#39;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_get_my_ip</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">my_ip</span> <span class="o">=</span> <span class="s1">&#39;123.123.123.123&#39;</span>

    <span class="k">class</span> <span class="nc">MockResponse</span><span class="p">:</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_body</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">json_body</span> <span class="o">=</span> <span class="n">json_body</span>

        <span class="k">def</span> <span class="nf">json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_body</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
        <span class="n">requests</span><span class="p">,</span>
        <span class="s1">&#39;get&#39;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">MockResponse</span><span class="p">({</span><span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="n">my_ip</span><span class="p">})</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">get_my_ip</span><span class="p">()</span> <span class="o">==</span> <span class="n">my_ip</span>
</code></pre></div>
<p>Cosa sta succedendo?</p>
<p>Usiamo la fixture <a href="https://docs.pytest.org/en/stable/monkeypatch.html">monkeypatch</a> per rimpiazare tutte le chiamate al metodo <code>get</code> dal modulo <code>requests</code> con il callback lambda che restituisce sempre un'istanza di <code>MockedResponse</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Usiamo un oggetto perché <code>requests</code> restituisce un oggetto Response.</p>
</div>
<p>Possiamo semplificare il test con il metodo create_autospec dal modulo unittest.mock. Questo metodo crea un oggetto mockato con le stesse proprietà e metodi dell'oggetto passato come parametro:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">mock</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">requests</span> <span class="kn">import</span> <span class="n">Response</span>


<span class="k">def</span> <span class="nf">get_my_ip</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s1">&#39;http://ipinfo.io/json&#39;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_get_my_ip</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">my_ip</span> <span class="o">=</span> <span class="s1">&#39;123.123.123.123&#39;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">create_autospec</span><span class="p">(</span><span class="n">Response</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="n">my_ip</span><span class="p">}</span>

    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setattr</span><span class="p">(</span>
        <span class="n">requests</span><span class="p">,</span>
        <span class="s1">&#39;get&#39;</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">response</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">get_my_ip</span><span class="p">()</span> <span class="o">==</span> <span class="n">my_ip</span>
</code></pre></div>
<p>Anche se pytest raccomanda l'approccio monkeypatch per il mocking, l'estensieone pytest-mock e la libreria unittest.mock dalla libreria standard sono approcci ottimi entrmabi.</p>
<h3 id="code-coveratge">code coveratge<a class="headerlink" href="#code-coveratge" title="Permanent link">&para;</a></h3>
<p>un altro aspetto importante del test è il code coverage. è una metrica che ci indica che il rapproto tra il numero di linee eseguiti duranti il test esegue ed il numero totale di righe nella nostra codebase. Possiamo usare il plugin pyutest-cov per questo, che integra Coverage.py con pytest.</p>
<p>Una volta installata, per eseguire i test con il report del coverage aggiungiamo l'opzione --cov:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>--cov<span class="o">=</span>.
</code></pre></div>
<p>Produrrà un output del genere:</p>
<div class="highlight"><pre><span></span><code><span class="o">==================================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==================================</span>
platform<span class="w"> </span>linux<span class="w"> </span>--<span class="w"> </span>Python<span class="w"> </span><span class="m">3</span>.7.9,<span class="w"> </span>pytest-5.4.3,<span class="w"> </span>py-1.9.0,<span class="w"> </span>pluggy-0.13.1
rootdir:<span class="w"> </span>/home/johndoe/sample-project
plugins:<span class="w"> </span>cov-2.10.1
collected<span class="w"> </span><span class="m">6</span><span class="w"> </span>items

tests/test_sample_project.py<span class="w"> </span>....<span class="w">                                             </span><span class="o">[</span><span class="w"> </span><span class="m">66</span>%<span class="o">]</span>
tests/test_sample_project_mock.py<span class="w"> </span>.<span class="w">                                           </span><span class="o">[</span><span class="w"> </span><span class="m">83</span>%<span class="o">]</span>
tests/test_sample_project_mock_1.py<span class="w"> </span>.<span class="w">                                         </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

-----------<span class="w"> </span>coverage:<span class="w"> </span>platform<span class="w"> </span>linux,<span class="w"> </span>python<span class="w"> </span><span class="m">3</span>.7.9-final-0<span class="w"> </span>-----------
Name<span class="w">                                  </span>Stmts<span class="w">   </span>Miss<span class="w">  </span>Cover
---------------------------------------------------------
sample_project/__init__.py<span class="w">                </span><span class="m">1</span><span class="w">      </span><span class="m">1</span><span class="w">     </span><span class="m">0</span>%
tests/__init__.py<span class="w">                         </span><span class="m">0</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">100</span>%
tests/test_sample_project.py<span class="w">              </span><span class="m">5</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">100</span>%
tests/test_sample_project_mock.py<span class="w">        </span><span class="m">13</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">100</span>%
tests/test_sample_project_mock_1.py<span class="w">      </span><span class="m">12</span><span class="w">      </span><span class="m">0</span><span class="w">   </span><span class="m">100</span>%
---------------------------------------------------------
TOTAL<span class="w">                                    </span><span class="m">31</span><span class="w">      </span><span class="m">1</span><span class="w">    </span><span class="m">97</span>%


<span class="o">==================================</span><span class="w">  </span><span class="m">6</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.13s<span class="w"> </span><span class="o">==================================</span>
</code></pre></div>
<p>Per ogni file nel percorso del progetto otteniamo:</p>
<ul>
<li>Stmts: numero di righe di codice</li>
<li>Miss: numero di righe che non sono state eseguitre dai test</li>
<li>cover: percentuale di copertura per il file</li>
</ul>
<p>Alla fine, vi è una linea con i totali per l'intero progetto.</p>
<p>Teniamo a mente che anche se è bene ottenere una percentuale di copertura alta, questo non significa che i nostri test siano buoni, e che testino tutti percorsi che possono essere seguiti dal codice. Per esempio, i test con assert sum(3, 2) == 5 può avere un'alta percentuale di copertura, ma il codice non è testato, dal momento che i percorsi delle eccezioni non sono coperte.</p>
<h2 id="mutation-testging">mutation testging<a class="headerlink" href="#mutation-testging" title="Permanent link">&para;</a></h2>
<p>Il mutation testing ci aiuta ad assicurarci che i nostri test coprano effettivamente l'intero comportamento del nostro codice. Messo in un altro modo, analizziamo l'efficacia o robustezza della nostra test suite. Durante il mutation testing, un tool itera attraverso ogni riga del nostro codice sorgente, facendom dei piccoli cambi (chiamati mutazioni) che potrebbero rompere il nostro codice. Dopo ogni mutazione, il tool esegue gli unit test e verifica se il nostro test fallisce o meno. Se i nostri test passano, allora il codice non è riuscito a passare il mutation test.</p>
<p>Ad esempio, imamginiamo di avere il seguente codice:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">50</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">100</span>
</code></pre></div>
<p>Il mutation tool può cambiare l'operatore da &gt; a &gt;=:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="n">x</span><span class="o">&gt;=</span> <span class="n">y</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">50</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">100</span>
</code></pre></div>
<p>mutmut è una libreria di mutation testing per Python. Vediamola in azione.</p>
<p>Immaginiamo di avere la seguente classe Prestiti:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># loan.py</span>

<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>


<span class="k">class</span> <span class="nc">LoanStatus</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">&quot;PENDING&quot;</span>
    <span class="n">ACCEPTED</span> <span class="o">=</span> <span class="s2">&quot;ACCEPTED&quot;</span>
    <span class="n">REJECTED</span> <span class="o">=</span> <span class="s2">&quot;REJECTED&quot;</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Loan</span><span class="p">:</span>
    <span class="n">amount</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">LoanStatus</span> <span class="o">=</span> <span class="n">LoanStatus</span><span class="o">.</span><span class="n">PENDING</span>

    <span class="k">def</span> <span class="nf">reject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">LoanStatus</span><span class="o">.</span><span class="n">REJECTED</span>

    <span class="k">def</span> <span class="nf">rejected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">LoanStatus</span><span class="o">.</span><span class="n">REJECTED</span>
</code></pre></div>
<p>Ora diciamo che vogliamo automaticamente respingere le richieste di mutuo che sono superiori a 250k:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># reject_loan.py</span>

<span class="k">def</span> <span class="nf">reject_loan</span><span class="p">(</span><span class="n">loan</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">loan</span><span class="o">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mf">250.000</span><span class="p">:</span>
        <span class="n">loan</span><span class="o">.</span><span class="n">reject</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">loan</span>
</code></pre></div>
<p>Scriviamo quindi il seguente test:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">loan</span> <span class="kn">import</span> <span class="n">loan</span>
<span class="kn">from</span> <span class="nn">reject_loan</span> <span class="kn">import</span> <span class="n">reject_loan</span>

<span class="k">def</span> <span class="nf">test_reject_loan</span><span class="p">():</span>
    <span class="n">loan</span> <span class="o">=</span> <span class="n">loan</span><span class="p">(</span><span class="n">amount</span><span class="o">=</span><span class="mi">100_000</span><span class="p">)</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">reject_loan</span><span class="p">(</span><span class="n">loan</span><span class="p">)</span><span class="o">.</span><span class="n">rejected</span><span class="p">()</span> 
</code></pre></div>
<p>Quando eseguiamo il mutation testing con mutmut, vedremo che avremo due mutazioni che sopravvivono:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mutmut<span class="w"> </span>run<span class="w"> </span>--paths-to-mutate<span class="w"> </span>reject_loan.py<span class="w"> </span>--tests-dir<span class="o">=</span>.

-<span class="w"> </span>Mutation<span class="w"> </span>testing<span class="w"> </span>starting<span class="w"> </span>-

These<span class="w"> </span>are<span class="w"> </span>the<span class="w"> </span>steps:
<span class="m">1</span>.<span class="w"> </span>A<span class="w"> </span>full<span class="w"> </span><span class="nb">test</span><span class="w"> </span>suite<span class="w"> </span>run<span class="w"> </span>will<span class="w"> </span>be<span class="w"> </span>made<span class="w"> </span>to<span class="w"> </span>make<span class="w"> </span>sure<span class="w"> </span>we
<span class="w">   </span>can<span class="w"> </span>run<span class="w"> </span>the<span class="w"> </span>tests<span class="w"> </span>successfully<span class="w"> </span>and<span class="w"> </span>we<span class="w"> </span>know<span class="w"> </span>how<span class="w"> </span>long
<span class="w">   </span>it<span class="w"> </span>takes<span class="w"> </span><span class="o">(</span>to<span class="w"> </span>detect<span class="w"> </span>infinite<span class="w"> </span>loops<span class="w"> </span><span class="k">for</span><span class="w"> </span>example<span class="o">)</span>
<span class="m">2</span>.<span class="w"> </span>Mutants<span class="w"> </span>will<span class="w"> </span>be<span class="w"> </span>generated<span class="w"> </span>and<span class="w"> </span>checked

Results<span class="w"> </span>are<span class="w"> </span>stored<span class="w"> </span><span class="k">in</span><span class="w"> </span>.mutmut-cache.
Print<span class="w"> </span>found<span class="w"> </span>mutants<span class="w"> </span>with<span class="w"> </span><span class="sb">`</span>mutmut<span class="w"> </span>results<span class="sb">`</span>.

Legend<span class="w"> </span><span class="k">for</span><span class="w"> </span>output:
🎉<span class="w"> </span>Killed<span class="w"> </span>mutants.<span class="w">   </span>The<span class="w"> </span>goal<span class="w"> </span>is<span class="w"> </span><span class="k">for</span><span class="w"> </span>everything<span class="w"> </span>to<span class="w"> </span>end<span class="w"> </span>up<span class="w"> </span><span class="k">in</span><span class="w"> </span>this<span class="w"> </span>bucket.
⏰<span class="w"> </span>Timeout.<span class="w">          </span>Test<span class="w"> </span>suite<span class="w"> </span>took<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="nb">times</span><span class="w"> </span>as<span class="w"> </span>long<span class="w"> </span>as<span class="w"> </span>the<span class="w"> </span>baseline<span class="w"> </span>so<span class="w"> </span>were<span class="w"> </span>killed.
🤔<span class="w"> </span>Suspicious.<span class="w">       </span>Tests<span class="w"> </span>took<span class="w"> </span>a<span class="w"> </span>long<span class="w"> </span>time,<span class="w"> </span>but<span class="w"> </span>not<span class="w"> </span>long<span class="w"> </span>enough<span class="w"> </span>to<span class="w"> </span>be<span class="w"> </span>fatal.
🙁<span class="w"> </span>Survived.<span class="w">         </span>This<span class="w"> </span>means<span class="w"> </span>your<span class="w"> </span>tests<span class="w"> </span>needs<span class="w"> </span>to<span class="w"> </span>be<span class="w"> </span>expanded.
🔇<span class="w"> </span>Skipped.<span class="w">          </span>Skipped.

<span class="m">1</span>.<span class="w"> </span>Running<span class="w"> </span>tests<span class="w"> </span>without<span class="w"> </span>mutations
⠏<span class="w"> </span>Running...Done

<span class="m">2</span>.<span class="w"> </span>Checking<span class="w"> </span>mutants
⠸<span class="w"> </span><span class="m">2</span>/2<span class="w">  </span>🎉<span class="w"> </span><span class="m">0</span><span class="w">  </span>⏰<span class="w"> </span><span class="m">0</span><span class="w">  </span>🤔<span class="w"> </span><span class="m">0</span><span class="w">  </span>🙁<span class="w"> </span><span class="m">2</span><span class="w">  </span>🔇<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<p>Possiamo vedere le mutazioni che sopravvivono in base al loro ID:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>mutmut<span class="w"> </span>show<span class="w"> </span><span class="m">1</span>

---<span class="w"> </span>reject_loan.py
+++<span class="w"> </span>reject_loan.py
@@<span class="w"> </span>-1,7<span class="w"> </span>+1,7<span class="w"> </span>@@
<span class="w"> </span><span class="c1"># reject_loan.py</span>

<span class="w"> </span>def<span class="w"> </span>reject_loan<span class="o">(</span>loan<span class="o">)</span>:
-<span class="w">    </span><span class="k">if</span><span class="w"> </span>loan.amount<span class="w"> </span>&gt;<span class="w"> </span>250_000:
+<span class="w">    </span><span class="k">if</span><span class="w"> </span>loan.amount<span class="w"> </span>&gt;<span class="o">=</span><span class="w"> </span>250_000:
<span class="w">         </span>loan.reject<span class="o">()</span>

<span class="w">     </span><span class="k">return</span><span class="w"> </span>loan
</code></pre></div>
<p>$ mutmut show 2</p>
<p>--- reject<em>loan.py<br />
+++ reject</em>loan.py<br />
@@ -1,7 +1,7 @@<br />
 # reject_loan.py</p>
<p>def reject<em>loan(loan):<br />
-    if loan.amount &gt; 250</em>000:<br />
+    if loan.amount &gt; 250001:<br />
         loan.reject()</p>
<div class="highlight"><pre><span></span><code> return loan
</code></pre></div>
<p>Miglioriamo il nostro testO:</p>
<p>from loan import Loan<br />
from reject<em>loan import reject</em>loan</p>
<p>def test<em>reject</em>loan():<br />
    loan = Loan(amount=100<em>000)<br />
    assert not reject</em>loan(loan).rejected()</p>
<div class="highlight"><pre><span></span><code>loan = Loan(amount=250_001)
assert reject_loan(loan).rejected()

loan = Loan(amount=250_000)
assert not reject_loan(loan).rejected()
</code></pre></div>
<p>Se facciamo di nuovo il nsotro mutation test, vedremo che nessuna mutazione è sopravvissuta:</p>
<p>$ mutmut run --paths-to-mutate reject_loan.py --tests-dir=.</p>
<ul>
<li>Mutation testing starting -</li>
</ul>
<p>These are the steps:<br />
1. A full test suite run will be made to make sure we<br />
   can run the tests successfully and we know how long<br />
   it takes (to detect infinite loops for example)<br />
2. Mutants will be generated and checked</p>
<p>Results are stored in .mutmut-cache.<br />
Print found mutants with <code>mutmut results</code>.</p>
<p>Legend for output:<br />
🎉 Killed mutants.   The goal is for everything to end up in this bucket.<br />
⏰ Timeout.          Test suite took 10 times as long as the baseline so were killed.<br />
🤔 Suspicious.       Tests took a long time, but not long enough to be fatal.<br />
🙁 Survived.         This means your tests needs to be expanded.<br />
🔇 Skipped.          Skipped.</p>
<ol>
<li>
<p>Running tests without mutations<br />
⠏ Running...Done</p>
</li>
<li>
<p>Checking mutants<br />
⠙ 2/2  🎉 2  ⏰ 0  🤔 0  🙁 0  🔇 0</p>
</li>
</ol>
<p>Adesso i nostri test sono molto più robusti. Un qualsiasi cambio non intenzionale all'intenro di <code>reject_loan.py</code> produrrà un test che fallisce.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>I tool di mutation testing per Python non sono maturi come quelli per altri linguaggi.POer esempoi, mtuatn è un mutation testing maturo per Ruby.</p>
</div>
<p>Così come per ogni altro approccio, il mutationt esting ha un tradeoff. Mentre miglirloa la abilità della nostra test suite di catturare dei bug, ha il costo di velocità dal momento che dobbiamo eseguire l'intera test suitee centinaia di volte. Ci forza inotlre a testare davvero tutto. QUesto ci aiuta a scoprire dei path di eccezioni, ma avremo molti test case minori da mantenere.</p>
<h2 id="todo-da-hypothesis">TODO: DA HYPOTHESIS<a class="headerlink" href="#todo-da-hypothesis" title="Permanent link">&para;</a></h2>
<p><a href="https://hypothesis.readthedocs.io/en/latest/">Hypotheisi</a> è una libreria per effettuare il property-based testing in Python. In pratica, pitutosto che scrivere differenti test case per ogni argomento da testare, il property-based testing genera un ampio range di dati di test casuali che sono dipendenti dalle precedenti run. Questo ci aiuta ad aumentare la robustezza della della nostra test suite e diminuire la ridondanza dei test. In breve, il codice di test sarà più pulito, più DRY, e più efficiente, mentre comunque copre un ampio range di dati di test.</p>
<p>Per esempio, diciamo di dover scrivere dei test per la seguente funzione:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div>
<p>Possiamo scrivere i seguenti test:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s1">&#39;number, result&#39;</span><span class="p">,</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">101234</span><span class="p">,</span> <span class="mi">101235</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">test_increment</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">increment</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">==</span> <span class="n">result</span>
</code></pre></div>
<p>Non vi è niente di sbagliato in questo approccio. Il codice è testato e la copertura è alta (100%, per essere satti). Detto questo, quanto bene è stato testato il codice rispetto al range dei possibili input? Vi sono molti interi che possono essere testati, ma solo quattro di loro sono usati nel test. In alcune situazioni questo è abbastanza. In altre situazioni quattro casi non sono abbastanza, ad esempio, nel codice machine learning (che non è detrerministico). COsa diciamo per dei numeri molto piccoli o grandi? o se la nostra funzione prende una lista di interi piuttosto che un singolo intero. E se la lista è vuota o contiene un elemnto, centtinaia di elementi, o migliaia di elemneti? In alcune situaizoni non possiamo semplicemente fornire (o anche pensare) tutti i possibili casi. E' qui che il test propertty-based viene in gioco.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Gli algoritmi di machine learning sono un use case ottimo per il property-based testing dal momento in cui è dificile produrre (e mantenere)) i campioni di test per insiemi di dati complessi.</p>
</div>
<p>I frmaework come hypothesis fornisce le ricette (chiamate <a href="https://hypothesis.readthedocs.io/en/latest/data.html?#core-strategies">Strategies</a>) per generare dati di test casuali. Hypothesis memorizza anche i risultati delle precedenti run di test e le use per creare nuovi casi.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Le strategie sono algoritmi che generano dati pseudo-casuali basate sulla forma dei dati input. E' pseudo-causuale perché i dati generati sono basati sui dati dai test precedenti.</p>
</div>
<p>Lo stesso test che usa il property-based testing mediante Hypothesis appare come segue:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">hypothesis</span> <span class="kn">import</span> <span class="n">given</span>
<span class="kn">import</span> <span class="nn">hypothesis.strategies</span> <span class="k">as</span> <span class="nn">st</span>

<span class="nd">@given</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">integers</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">test_add_one</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">increment</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">==</span> <span class="n">num</span> <span class="o">-</span> <span class="mi">1</span>
</code></pre></div>
<p><code>st.integers()</code> è una strategia Hypothesis che genbera deglki interti casuali per il test mentre il decorator <code>@given</code> è usato per parametrizzare la funzione di test. Per cui quando la funzione di test è chiamato, gli interi generati, dalla strategiua, saranno passati nei test.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>pytest<span class="w"> </span>test_hypothesis.py<span class="w"> </span>--hypothesis-show-statistics

<span class="o">==================================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">===================================</span>
platform<span class="w"> </span>darwin<span class="w"> </span>--<span class="w"> </span>Python<span class="w"> </span><span class="m">3</span>.8.5,<span class="w"> </span>pytest-6.1.1,<span class="w"> </span>py-1.9.0,<span class="w"> </span>pluggy-0.13.1
rootdir:<span class="w"> </span>/home/johndoe/sample-project
plugins:<span class="w"> </span>hypothesis-5.37.3
collected<span class="w"> </span><span class="m">1</span><span class="w"> </span>item

test_hypothesis.py<span class="w"> </span>.<span class="w">                                                               </span><span class="o">[</span><span class="m">100</span>%<span class="o">]</span>
<span class="o">=================================</span><span class="w"> </span>Hypothesis<span class="w"> </span><span class="nv">Statistics</span><span class="w"> </span><span class="o">==================================</span>

test_hypothesis.py::test_add_one:

<span class="w">  </span>-<span class="w"> </span>during<span class="w"> </span>generate<span class="w"> </span>phase<span class="w"> </span><span class="o">(</span><span class="m">0</span>.06<span class="w"> </span>seconds<span class="o">)</span>:
<span class="w">    </span>-<span class="w"> </span>Typical<span class="w"> </span>runtimes:<span class="w"> </span>&lt;<span class="w"> </span>1ms,<span class="w"> </span>~<span class="w"> </span><span class="m">50</span>%<span class="w"> </span><span class="k">in</span><span class="w"> </span>data<span class="w"> </span>generation
<span class="w">    </span>-<span class="w"> </span><span class="m">100</span><span class="w"> </span>passing<span class="w"> </span>examples,<span class="w"> </span><span class="m">0</span><span class="w"> </span>failing<span class="w"> </span>examples,<span class="w"> </span><span class="m">0</span><span class="w"> </span>invalid<span class="w"> </span>examples

<span class="w">  </span>-<span class="w"> </span>Stopped<span class="w"> </span>because<span class="w"> </span>settings.max_examples<span class="o">=</span><span class="nv">100</span>


<span class="o">===================================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.08s<span class="w"> </span><span class="o">====================================</span>
</code></pre></div>
<h2 id="type-checking">type checking<a class="headerlink" href="#type-checking" title="Permanent link">&para;</a></h2>
<p>I test sono codice, e devono esere trrattati di conseguenza. Come il codice di business, dobbiamo mantenerli e fare il refactoring. Possiamo dover affrontare i bug di volta in volta. A causa di questo, è una buona pratica mantenere i test corti, semplici, e dritti al punto. Dovremmo anche occuparci di non effettuare troppi test sul codice.</p>
<p>I type checker a runtime, o dinamici, come <a href="https://typeguard.readthedocs.io/">Typeguard</a> e <a href="https://pydantic-docs.helpmanual.io/">pydantic</a>, possono aituare a minimizzare il numero di test. Vediamo ad un esempio di questo con pydantic.</p>
<p>Per esempio, diciamo di avere un <code>User</code> che ha un singolo attributo, un indirizzo email:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">User</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>


<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s1">&#39;john@doe.com&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Vogliamo assicuraci che la mail fornita sia un indirizzo effettivamente valido. PEr cui, per validarlo, dovremo aggiungere da qualche parte del codice helper. Assieme alla scrittura di test, dovremo anche spendere del tempo per scrivere le espressioni regolari per questo. pydantic può aiutarci. Possiamo usarlo per derinife ril nostro modello User:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>


<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="s1">&#39;john@doe.com&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Ora, l'argomento email sarà validato da pydantic prima che ogni istanza di User sia creata. Quando non è una mail valida (ad esempio, User(email='something')) un ValidationError sarà lanciato. Qeusto elimina la necessità dis crivere il nostro validatore. Non dobbiamo neanche testarlo perché i mantainer di pydantic lo fanno per noi.</p>
<p>Possiamo ridure il numero di test per ogni dato fornito dall'utente. E, invece, dobbiamo semplciemente testare che un ValidationError sia gestito correttamente.</p>
<p>Vediamo un rapido esempio in un'app Flask:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">uuid</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span><span class="p">,</span> <span class="n">Field</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="n">ValidationError</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">handle_validation_exception</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">errors</span><span class="p">())</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">400</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="k">class</span> <span class="nc">Blog</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()))</span>
    <span class="n">author</span><span class="p">:</span> <span class="n">EmailStr</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">content</span><span class="p">:</span> <span class="nb">str</span>
</code></pre></div>
<p>Il test diventa:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>


<span class="k">def</span> <span class="nf">test_create_blog_bad_request</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GIVEN request data with invalid values or missing attributes</span>
<span class="sd">    WHEN endpoint /create-blog/ is called</span>
<span class="sd">    THEN it should return status 400 and JSON body</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s1">&#39;/create-blog/&#39;</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="p">{</span>
            <span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="s1">&#39;John Doe&#39;</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;Some extra awesome content&#39;</span>
        <span class="p">}</span>
        <span class="p">),</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">400</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</code></pre></div>
<h2 id="conclusioni">Conclusioni<a class="headerlink" href="#conclusioni" title="Permanent link">&para;</a></h2>
<p>Il test può essere alle volte un compito scooraggiante. Ci sono sempre delle volte in cui lo sarà, ma abbiamo visto delle tecniche e deglis trumenti che possiamo usare per rendere ilt est più semplice. Focalizziamo gli sforzi di testing sul diminuire i test inutili. I nostri test dovrebbero anche essere veloci, isolati, indipendenti, deterministici e ripetibili. Alla fine, avere confidenza nella nostra suite di test ci aiuterà ad efettuare il deploy in produzione più spesso e dormire sogni tranquilli.</p>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; Angelo Cardellicchio - MIT License
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/anhelus" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
    <a href="mailto:angelo.cardellicchio@poliba.it" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480v-83.6c0-4 1.5-7.8 4.2-10.7l167.6-182.9c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8l-88.3-44.2C7.1 311.3.3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": [], "search": "../../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copiato", "clipboard.copy": "Copia", "search.result.more.one": "1 altro in questa pagina", "search.result.more.other": "# altri in questa pagina", "search.result.none": "Nessun documento trovato", "search.result.one": "1 documento trovato", "search.result.other": "# documenti trovati", "search.result.placeholder": "Scrivi per iniziare a cercare", "search.result.term.missing": "Non presente", "select.version": "Seleziona la versione"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.c18c5fb9.min.js"></script>
      
        <script src="../../../../js/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>